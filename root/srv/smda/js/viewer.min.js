var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();$jscomp.initSymbol();$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};
$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("WeakMap",function(a){function b(a){$jscomp.owns(a,d)||$jscomp.defineProperty(a,d,{value:{}})}function c(a){var c=Object[a];c&&(Object[a]=function(a){b(a);return c(a)})}if(function(){if(!a||!Object.seal)return!1;try{var b=Object.seal({}),c=Object.seal({}),d=new a([[b,2],[c,3]]);if(2!=d.get(b)||3!=d.get(c))return!1;d.delete(b);d.set(c,4);return!d.has(b)&&4==d.get(c)}catch(l){return!1}}())return a;var d="$jscomp_hidden_"+Math.random().toString().substring(2);c("freeze");c("preventExtensions");
c("seal");var e=0,f=function(a){this.id_=(e+=Math.random()+1).toString();if(a){$jscomp.initSymbol();$jscomp.initSymbolIterator();a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};f.prototype.set=function(a,c){b(a);if(!$jscomp.owns(a,d))throw Error("WeakMap key fail: "+a);a[d][this.id_]=c;return this};f.prototype.get=function(a){return $jscomp.owns(a,d)?a[d][this.id_]:void 0};f.prototype.has=function(a){return $jscomp.owns(a,d)&&$jscomp.owns(a[d],this.id_)};f.prototype.delete=
function(a){return $jscomp.owns(a,d)&&$jscomp.owns(a[d],this.id_)?delete a[d][this.id_]:!1};return f},"es6","es3");$jscomp.MapEntry=function(){};
$jscomp.polyfill("Map",function(a){if(!$jscomp.ASSUME_NO_NATIVE_MAP&&function(){if(!a||!a.prototype.entries||"function"!=typeof Object.seal)return!1;try{var b=Object.seal({x:4}),c=new a($jscomp.makeIterator([[b,"s"]]));if("s"!=c.get(b)||1!=c.size||c.get({x:4})||c.set({x:4},"t")!=c||2!=c.size)return!1;var d=c.entries(),e=d.next();if(e.done||e.value[0]!=b||"s"!=e.value[1])return!1;e=d.next();return e.done||4!=e.value[0].x||"t"!=e.value[1]||!d.next().done?!1:!0}catch(u){return!1}}())return a;$jscomp.initSymbol();
$jscomp.initSymbolIterator();var b=new WeakMap,c=function(a){this.data_={};this.head_=f();this.size=0;if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};c.prototype.set=function(a,b){var c=d(this,a);c.list||(c.list=this.data_[c.id]=[]);c.entry?c.entry.value=b:(c.entry={next:this.head_,previous:this.head_.previous,head:this.head_,key:a,value:b},c.list.push(c.entry),this.head_.previous.next=c.entry,this.head_.previous=c.entry,this.size++);return this};c.prototype.delete=
function(a){a=d(this,a);return a.entry&&a.list?(a.list.splice(a.index,1),a.list.length||delete this.data_[a.id],a.entry.previous.next=a.entry.next,a.entry.next.previous=a.entry.previous,a.entry.head=null,this.size--,!0):!1};c.prototype.clear=function(){this.data_={};this.head_=this.head_.previous=f();this.size=0};c.prototype.has=function(a){return!!d(this,a).entry};c.prototype.get=function(a){return(a=d(this,a).entry)&&a.value};c.prototype.entries=function(){return e(this,function(a){return[a.key,
a.value]})};c.prototype.keys=function(){return e(this,function(a){return a.key})};c.prototype.values=function(){return e(this,function(a){return a.value})};c.prototype.forEach=function(a,b){for(var c=this.entries(),d;!(d=c.next()).done;)d=d.value,a.call(b,d[1],d[0],this)};c.prototype[Symbol.iterator]=c.prototype.entries;var d=function(a,c){var d=c&&typeof c;"object"==d||"function"==d?b.has(c)?d=b.get(c):(d=""+ ++g,b.set(c,d)):d="p_"+c;var e=a.data_[d];if(e&&$jscomp.owns(a.data_,d))for(a=0;a<e.length;a++){var f=
e[a];if(c!==c&&f.key!==f.key||c===f.key)return{id:d,list:e,index:a,entry:f}}return{id:d,list:e,index:-1,entry:void 0}},e=function(a,b){var c=a.head_;return $jscomp.iteratorPrototype(function(){if(c){for(;c.head!=a.head_;)c=c.previous;for(;c.next!=c.head;)return c=c.next,{done:!1,value:b(c)};c=null}return{done:!0,value:void 0}})},f=function(){var a={};return a.previous=a.next=a.head=a},g=0;return c},"es6","es3");
$jscomp.polyfill("Set",function(a){if(!$jscomp.ASSUME_NO_NATIVE_SET&&function(){if(!a||!a.prototype.entries||"function"!=typeof Object.seal)return!1;try{var b=Object.seal({x:4}),d=new a($jscomp.makeIterator([b]));if(!d.has(b)||1!=d.size||d.add(b)!=d||1!=d.size||d.add({x:4})!=d||2!=d.size)return!1;var e=d.entries(),f=e.next();if(f.done||f.value[0]!=b||f.value[1]!=b)return!1;f=e.next();return f.done||f.value[0]==b||4!=f.value[0].x||f.value[1]!=f.value[0]?!1:e.next().done}catch(g){return!1}}())return a;
$jscomp.initSymbol();$jscomp.initSymbolIterator();var b=function(a){this.map_=new Map;if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)this.add(b.value)}this.size=this.map_.size};b.prototype.add=function(a){this.map_.set(a,a);this.size=this.map_.size;return this};b.prototype.delete=function(a){a=this.map_.delete(a);this.size=this.map_.size;return a};b.prototype.clear=function(){this.map_.clear();this.size=0};b.prototype.has=function(a){return this.map_.has(a)};b.prototype.entries=function(){return this.map_.entries()};
b.prototype.values=function(){return this.map_.values()};b.prototype.keys=b.prototype.values;b.prototype[Symbol.iterator]=b.prototype.values;b.prototype.forEach=function(a,b){var c=this;this.map_.forEach(function(d){return a.call(b,d,d,c)})};return b},"es6","es3");$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};
$jscomp.polyfill("Array.prototype.findIndex",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).i}},"es6","es3");$jscomp.polyfill("Math.log2",function(a){return a?a:function(a){return Math.log(a)/Math.LN2}},"es6","es3");$jscomp.polyfill("Math.sign",function(a){return a?a:function(a){a=Number(a);return 0===a||isNaN(a)?a:0<a?1:-1}},"es6","es3");
$jscomp.polyfill("Object.assign",function(a){return a?a:function(a,c){for(var b=1;b<arguments.length;b++){var e=arguments[b];if(e)for(var f in e)$jscomp.owns(e,f)&&(a[f]=e[f])}return a}},"es6","es3");$jscomp.polyfill("Object.values",function(a){return a?a:function(a){var b=[],d;for(d in a)$jscomp.owns(a,d)&&b.push(a[d]);return b}},"es8","es3");
$jscomp.polyfill("Array.from",function(a){return a?a:function(a,c,d){$jscomp.initSymbolIterator();c=null!=c?c:function(a){return a};var b=[],f=a[Symbol.iterator];if("function"==typeof f)for(a=f.call(a);!(f=a.next()).done;)b.push(c.call(d,f.value));else{f=a.length;for(var g=0;g<f;g++)b.push(c.call(d,a[g]))}return b}},"es6","es3");
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.polyfill("Number.isFinite",function(a){return a?a:function(a){return"number"!==typeof a?!1:!isNaN(a)&&Infinity!==a&&-Infinity!==a}},"es6","es3");$jscomp.polyfill("Number.isInteger",function(a){return a?a:function(a){return Number.isFinite(a)?a===Math.floor(a):!1}},"es6","es3");$jscomp.polyfill("Math.trunc",function(a){return a?a:function(a){a=Number(a);if(isNaN(a)||Infinity===a||-Infinity===a||0===a)return a;var b=Math.floor(Math.abs(a));return 0>a?-b:b}},"es6","es3");
function ViewerShader(a){this.gl=a;this.uniform=this.attrib=this.program=null}
ViewerShader.prototype.initialize=function(a){var b=a.vertex||[],c=a.fragment||[];a=this.gl;this.program=a.createProgram();for(var d=b.length-1;0<=d;d--){var e=this.compileShader(b[d]);if(!e)return!1;a.attachShader(this.program,e)}for(b=c.length-1;0<=b;b--){d=this.compileShader(c[b]);if(!d)return!1;a.attachShader(this.program,d)}a.linkProgram(this.program);if(!a.getProgramParameter(this.program,a.LINK_STATUS))return a=a.getProgramInfoLog(this.program),alert("Could not initialize shaders: "+a),!1;
this.attrib={};for(c=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES)-1;0<=c;c--)b=a.getActiveAttrib(this.program,c).name,this.attrib[b]=a.getAttribLocation(this.program,b);this.uniform={};for(c=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS)-1;0<=c;c--)b=a.getActiveUniform(this.program,c).name,this.uniform[b]=a.getUniformLocation(this.program,b);return!0};
ViewerShader.prototype.compileShader=function(a){var b=this.gl,c=document.getElementById(a);if(!c)return console.log('failed to find "'+a+'" element'),null;for(var d="",e=c.firstChild;e;)e.nodeType==Node.TEXT_NODE&&(d+=e.textContent),e=e.nextSibling;if("x-shader/x-fragment"==c.type)a=b.createShader(b.FRAGMENT_SHADER);else if("x-shader/x-vertex"==c.type)a=b.createShader(b.VERTEX_SHADER);else return console.log("no valid shader type found for "+a),null;b.shaderSource(a,d);b.compileShader(a);return b.getShaderParameter(a,
b.COMPILE_STATUS)?a:(b=b.getShaderInfoLog(a),console.log("Shader type: "+c.type+" error: "+b+" source "+d),alert("Failed to compile shader: "+b),null)};function ViewerCanvas(a,b,c){this.context=a;this.axis=b;this.axis_prefix=c;this.base_width=this.base_height=256;this.viewport=this.gl=this.parent=this.row=this.composite_tex=this.composite_fb=null;this.shdr={};this.width_perc=100;this.minimap_enabled=!1;this.id="canvas_"+b;this.element=angular.element('<canvas id="'+this.id+'" class="panelCanvas"></canvas>');this.element.mousemove(this.onDefaultMouseMove.bind(this));this.element.mouseout(this.onDefaultMouseOut.bind(this));this.element.hide();this.spinner_key=
b+"_spinner";this.spinner=a.createSpinnerElement(this.spinner_key);$(window).resize(this.resize.bind(this));this.ortho={left:-.5,right:.5,bottom:-.5,top:.5,near:-2,far:10.1};this.p_matrix=mat4.create();mat4.ortho(this.p_matrix,this.ortho.left,this.ortho.right,this.ortho.bottom,this.ortho.top,this.ortho.near,this.ortho.far);this.ortho_xspan=this.ortho.right-this.ortho.left;this.ortho_yspan=this.ortho.top-this.ortho.bottom;this.ortho_xoffset=this.ortho.left;this.ortho_yoffset=this.ortho.bottom;this.mv_matrix=
mat4.create();this.plane={left:null,top:null,right:null,bottom:null,width:null,height:null};this.mos_win_pos={x:0,y:0};this.prev_mos_pos={x:0,y:0};this.mos_pos=[0,0];this.active=!1;this.active_views=[];this.minimap_arr=new Float32Array(15);this.crosshair_arr=new Float32Array(12);this.view_left=this.view_bottom=this.view_right=this.view_top=0;this.letter_texture=null;this.axis_letters=("coronal"==this.axis?"SRIL":"axial"==this.axis?"ARPL":"SPIA").split("");this.minimap_size=.25;this.minimap_enabled=
!0;this.loading_set=new Set;this.tooltip_id="canvas_"+b;this.tooltip=angular.element('<span id="'+this.tooltip_id+'" class="panelTooltip"></span>');this.tooltip.text("text");this.tooltip.hide()}ViewerCanvas.prototype.setHTMLElementParents=function(a,b){this.parent=a;this.row=b};ViewerCanvas.prototype.addToLoadingSet=function(a){this.loading_set.add(a);this.activateSpinner()};ViewerCanvas.prototype.removeFromLoadingSet=function(a){this.loading_set.delete(a);0==this.loading_set.size&&this.deactivateSpinner()};
ViewerCanvas.prototype.initializeGL=function(){var a=null;try{a=this.gl=this.element[0].getContext("experimental-webgl",{alpha:!1});a.getExtension("OES_texture_float")||alert("no floating point texture support");var b=a.getParameter(a.VIEWPORT);this.viewport={x:b[0],y:b[1],w:b[2],h:b[3]};this.shdr.color=new ViewerShader(a);this.shdr.color.initialize({vertex:["shader-vs"],fragment:["shader-fs-color"]});this.shdr.white=new ViewerShader(a);this.shdr.white.initialize({vertex:["shader-vs"],fragment:["shader-fs-white"]});
this.shdr.basic_tex=new ViewerShader(a);this.shdr.basic_tex.initialize({vertex:["shader-vs-tex"],fragment:["shader-fs-tex"]});this.shdr.no_alpha_tex=new ViewerShader(a);this.shdr.no_alpha_tex.initialize({vertex:["shader-vs-tex"],fragment:["shader-fs-no-alpha-tex"]});this.pos_bf=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.pos_bf);a.bufferData(a.ARRAY_BUFFER,new Float32Array([this.ortho_xoffset,-this.ortho_yoffset,0,-this.ortho_xoffset,-this.ortho_yoffset,0,-this.ortho_xoffset,this.ortho_yoffset,
0,this.ortho_xoffset,-this.ortho_yoffset,0,-this.ortho_xoffset,this.ortho_yoffset,0,this.ortho_xoffset,this.ortho_yoffset,0]),a.STATIC_DRAW);this.pos_bf.item_sz=3;this.pos_bf.item_n=6;this.texcoord_bf=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.texcoord_bf);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]),a.STATIC_DRAW);this.texcoord_bf.item_sz=2;this.texcoord_bf.item_n=6;this.crosshair_bf=a.createBuffer();this.minimap_bf=a.createBuffer()}catch(c){console.log("Exception occurred: "+
c)}a||alert("Could not initialize WebGL, sorry")};
ViewerCanvas.prototype.initializeFramebuffer=function(){var a=this.gl;null!==this.composite_fb&&(a.deleteTexture(this.composite_tex),a.deleteFramebuffer(this.composite_fb),this.composite_fb=this.composite_tex=null);if(0!=this.viewport.w){this.composite_fb=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,this.composite_fb);this.composite_tex=a.createTexture();this.composite_w=this.viewport.w;this.composite_h=this.viewport.h;a.bindTexture(a.TEXTURE_2D,this.composite_tex);a.texImage2D(a.TEXTURE_2D,
0,a.RGB,this.composite_w,this.composite_h,0,a.RGB,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.composite_tex,0);a.bindTexture(a.TEXTURE_2D,null);if(a.checkFramebufferStatus(a.FRAMEBUFFER)!=a.FRAMEBUFFER_COMPLETE)switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_UNDEFINED:console.log("FRAMEBUFFER_UNDEFINED");
break;case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.log("FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.log("FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DRAW_BUFFER:console.log("FRAMEBUFFER_INCOMPLETE_DRAW_BUFFER");break;case a.FRAMEBUFFER_UNSUPPORTED:console.log("FRAMEBUFFER_UNSUPPORTED")}a.viewport(0,0,this.composite_w,this.composite_h);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);a.bindFramebuffer(a.FRAMEBUFFER,
null)}};ViewerCanvas.prototype._processPageCoordinates=function(a){a=a||window.event;if(null==a.pageX&&null!=a.clientX){var b=a.target&&a.target.ownerDocument||document,c=b.documentElement;b=b.body;a.pageX=a.clientX+(c&&c.scrollLeft||b&&b.scrollLeft||0)-(c&&c.clientLeft||b&&b.clientLeft||0);a.pageY=a.clientY+(c&&c.scrollTop||b&&b.scrollTop||0)-(c&&c.clientTop||b&&b.clientTop||0)}return a};
ViewerCanvas.prototype.resize=function(){var a=Math.max(0,Math.floor(this.parent.parent().width()*this.width_perc/this.base_width));0==a&&(a=1);this.parent.css({width:this.base_width*a+"px",height:this.base_height*Math.max(1,a)+"px"});a=this.gl.canvas;var b=a.clientWidth,c=a.clientHeight;if(a.width!=b||a.height!=c)this.viewport.w=a.width=b,this.viewport.h=a.height=c;this.initializeFramebuffer()};ViewerCanvas.prototype.activateSpinner=function(){this.context.activateSpinner(this.spinner_key)};
ViewerCanvas.prototype.deactivateSpinner=function(){this.context.deactivateSpinner(this.spinner_key)};
ViewerCanvas.prototype.onDefaultMouseMove=function(a){a=this._processPageCoordinates(a);var b=this.element[0].getBoundingClientRect();this.mos_win_pos={x:a.pageX-(b.left+window.scrollX),y:a.pageY-(b.top+window.scrollY)};this.mos_pos=this.unProject(this.mos_win_pos.x,this.mos_win_pos.y);this.wheel_delta=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));a=1/this.context[this.axis_prefix+"magnification"]/this.context[this.axis_prefix+"scale"];this.onMousePoint(this.mos_pos.x*a+this.context["pan_"+this.axis_prefix+
"x"],this.mos_pos.y*a+this.context["pan_"+this.axis_prefix+"y"])};ViewerCanvas.prototype.onDefaultMouseOut=function(a){this.onMouseOut()};ViewerCanvas.prototype.unProject=function(a,b,c){var d=this.element.prop("clientWidth"),e=this.element.prop("clientHeight");c=c?c:this.ortho;return{x:(c.right-c.left)*a/d+c.left,y:(c.top-c.bottom)*(e-b)/e+c.bottom}};ViewerCanvas.prototype.toggleMinimap=function(){this.minimap_enabled=!this.minimap_enabled};
ViewerCanvas.prototype.checkPanBounds=function(){var a=this.axis_prefix,b=this.context["pan_"+a+"y"],c=1/this.context[a+"magnification"]/this.context[a+"scale"];this.view_left=this.context["pan_"+a+"x"]+this.ortho_xoffset*c;this.view_bottom=b+this.ortho_yoffset*c;this.view_right=this.view_left+this.ortho_xspan*c;this.view_top=this.view_bottom+this.ortho_yspan*c;a=$jscomp.makeIterator(this.active_views);for(b=a.next();!b.done;b=a.next())b.value.checkPanBounds(this)};
ViewerCanvas.prototype.activateView=function(a){-1==this.active_views.findIndex(function(b){return b===a})&&(this.active_views.push(a),this.sortViews(),this.element.show(),this.parent.show(),this.row.element.show(),this.adjustRowSize())};
ViewerCanvas.prototype.deactivateView=function(a){var b=this.active_views.findIndex(function(b){return b===a});if(-1!=b)if(this.active_views.splice(b,1),0==this.active_views.length){this.element.hide();this.tooltip.hide();this.parent.hide();this.adjustRowSize();for(var c in this.row.canvas)if(this.row.canvas[c].active_views.length)return 0;this.row.element.hide()}else this.sortViews()};
ViewerCanvas.prototype.sortViews=function(){this.active_views.sort(function(a,b){return b.getLayer()-a.getLayer()});return this.active_views};ViewerCanvas.prototype.isActive=function(){return 0<this.active_views.length};
ViewerCanvas.prototype.adjustRowSize=function(){var a=Math.pow(2,Math.ceil(Math.log2("sagittal"==this.axis?2:0<this.context.canvas.axial.active_views.length?2:1)));a=Math.ceil(a/Math.floor(Math.sqrt(a)));var b=this.context.canvas_container.width();a=(b/a-1*(a-1))/b;for(var c in this.row.canvas)b=this.row.canvas[c],b.width_perc=b.active_views?a:0,b.resize()};
ViewerCanvas.prototype.drawCrosshair=function(){var a=this.context,b=this.gl,c=a.crosshair,d=this.shdr.white,e=a["pan_"+this.axis_prefix+"x"],f=a["pan_"+this.axis_prefix+"y"],g=a[this.axis_prefix+"magnification"],h=a[this.axis_prefix+"scale"],k=g*h;g*=h;b.disable(b.CULL_FACE);b.enable(b.BLEND);b.blendFunc(b.ONE_MINUS_DST_COLOR,b.ZERO);b.useProgram(d.program);mat4.identity(this.mv_matrix);mat4.translate(this.mv_matrix,this.mv_matrix,[-e*k,-f*g,0]);mat4.scale(this.mv_matrix,this.mv_matrix,[k,g,1]);
b.uniformMatrix4fv(d.uniform.uPMatrix,!1,this.p_matrix);b.uniformMatrix4fv(d.uniform.uMVMatrix,!1,this.mv_matrix);b.bindBuffer(b.ARRAY_BUFFER,this.crosshair_bf);e=c.x;f=c.y;"coronal"!=this.axis&&("axial"==this.axis?(e=c.x,f=-c.z):"sagittal"==this.axis&&(e=c.z,f=c.y));c=this.plane.bottom/("axial"==this.axis?a.volume.front:a.volume.bottom);e*=this.plane.left/("sagittal"==this.axis?a.volume.front:a.volume.left);f*=c;this.crosshair_arr.set([Math.min(-1,this.view_left),f,-.5,Math.max(1,this.view_right),
f,-.5,e,Math.min(-1,this.view_bottom),-.5,e,Math.max(1,this.view_top),-.5]);b.bufferData(b.ARRAY_BUFFER,this.crosshair_arr,b.STATIC_DRAW);b.enableVertexAttribArray(d.attrib.aPosition);b.vertexAttribPointer(d.attrib.aPosition,3,b.FLOAT,!1,0,0);b.lineWidth(1);b.drawArrays(b.LINES,0,4)};
ViewerCanvas.prototype.drawAxisLabels=function(){var a=this.context,b=this.gl,c=this.shdr.no_alpha_tex;b.disable(b.CULL_FACE);b.enable(b.BLEND);b.blendFunc(b.ONE_MINUS_DST_COLOR,b.ONE_MINUS_SRC_ALPHA);b.useProgram(c.program);b.uniformMatrix4fv(c.uniform.uPMatrix,!1,this.p_matrix);b.uniformMatrix4fv(c.uniform.uMVMatrix,!1,this.mv_matrix);b.activeTexture(b.TEXTURE0);b.uniform1i(c.uniform.uSampler,0);b.uniform1f(c.uniform.uAlpha,1);if(!this.letter_texture){var d=document.createElement("canvas").getContext("2d");
d.canvas.width=64;d.canvas.height=64;d.font="60px monospace";d.textAlign="center";d.textBaseline="middle";d.fillStyle="white";this.letter_texture={};for(var e in this.axis_letters){var f=this.axis_letters[e];d.clearRect(0,0,64,64);d.fillText(f,32,32);var g=b.createTexture();b.bindTexture(b.TEXTURE_2D,g);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,d.canvas);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);this.letter_texture[f]=g}}b.enableVertexAttribArray(c.attrib.aPosition);b.enableVertexAttribArray(c.attrib.aTexCoord);b.bindBuffer(b.ARRAY_BUFFER,this.texcoord_bf);d=a.half_pi;for(var h in this.axis_letters)e=this.axis_letters[h],f=.45*Math.cos(d)*this.ortho_xspan,g=.45*Math.sin(d)*this.ortho_yspan,mat4.identity(this.mv_matrix),mat4.translate(this.mv_matrix,this.mv_matrix,[f,g,0]),mat4.scale(this.mv_matrix,this.mv_matrix,[.08,.08,1]),b.uniformMatrix4fv(c.uniform.uMVMatrix,
!1,this.mv_matrix),b.bindTexture(b.TEXTURE_2D,this.letter_texture[e]),b.bindBuffer(b.ARRAY_BUFFER,this.pos_bf),b.vertexAttribPointer(c.attrib.aPosition,3,b.FLOAT,!1,0,0),b.bindBuffer(b.ARRAY_BUFFER,this.texcoord_bf),b.vertexAttribPointer(c.attrib.aTexCoord,this.texcoord_bf.item_sz,b.FLOAT,!1,0,0),b.drawArrays(b.TRIANGLES,0,this.pos_bf.item_n),d-=a.half_pi;b.disableVertexAttribArray(c.attrib.aTexCoord);b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA)};
ViewerCanvas.prototype.drawMinimap=function(){var a=this.context,b=this.gl,c=this.shdr.no_alpha_tex,d=b.getParameter(b.VIEWPORT),e=b.getParameter(b.FRAMEBUFFER_BINDING);b.bindFramebuffer(b.FRAMEBUFFER,this.composite_fb);b.viewport(0,0,this.composite_w,this.composite_h);b.clearColor(.3,.3,.3,1);b.clearDepth(1E3);b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);b.enable(b.BLEND);b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA);b.useProgram(c.program);b.activeTexture(b.TEXTURE0);b.uniform1i(c.uniform.uSampler,
0);for(var f in this.active_views){var g=this.active_views[f].panels[this.axis];if(g&&null!==g.pos_bf){var h=g.getSlice(g.slice);if(h&&h.preview.is_ready&&null!==h.preview.tex){var k=g.attrib,l=(k&&"horizontal_flip"in k?-1:1)*(k&&"xscale"in k?k.xscale:1),t=(k&&"vertical_flip"in k?-1:1)*(k&&"yscale"in k?k.yscale:1);k=k&&"rotate"in k?k.rotate:0;mat4.identity(this.mv_matrix);mat4.translate(this.mv_matrix,this.mv_matrix,[0,0,0]);mat4.scale(this.mv_matrix,this.mv_matrix,[l,t,1]);mat4.rotate(this.mv_matrix,
this.mv_matrix,k,[0,0,1]);b.uniformMatrix4fv(c.uniform.uPMatrix,!1,this.p_matrix);b.uniformMatrix4fv(c.uniform.uMVMatrix,!1,this.mv_matrix);b.bindTexture(b.TEXTURE_2D,h.preview.tex);b.uniform1f(c.uniform.uAlpha,g.view.alpha/a.max_alpha);b.bindBuffer(b.ARRAY_BUFFER,g.pos_bf);b.enableVertexAttribArray(c.attrib.aPosition);b.vertexAttribPointer(c.attrib.aPosition,g.pos_bf.item_sz,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,g.texcoord_bf);b.enableVertexAttribArray(c.attrib.aTexCoord);b.vertexAttribPointer(c.attrib.aTexCoord,
g.texcoord_bf.item_sz,b.FLOAT,!1,0,0);b.drawArrays(b.TRIANGLES,0,g.pos_bf.item_n)}}}b.useProgram(c.program);b.bindFramebuffer(b.FRAMEBUFFER,e);b.viewport(d[0],d[1],d[2],d[3]);d=this.minimap_size;e=this.ortho.right/d-this.ortho.right;f=this.ortho.top/d-this.ortho.top;mat4.identity(this.mv_matrix);mat4.scale(this.mv_matrix,this.mv_matrix,[d,-d,1]);mat4.translate(this.mv_matrix,this.mv_matrix,[e,-f,0]);b.uniformMatrix4fv(c.uniform.uPMatrix,!1,this.p_matrix);b.uniformMatrix4fv(c.uniform.uMVMatrix,!1,
this.mv_matrix);b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,this.composite_tex);b.uniform1i(c.uniform.uSampler,0);b.uniform1f(c.uniform.uAlpha,1);b.bindBuffer(b.ARRAY_BUFFER,this.pos_bf);b.enableVertexAttribArray(c.attrib.aPosition);b.vertexAttribPointer(c.attrib.aPosition,this.pos_bf.item_sz,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,this.texcoord_bf);b.enableVertexAttribArray(c.attrib.aTexCoord);b.vertexAttribPointer(c.attrib.aTexCoord,this.texcoord_bf.item_sz,b.FLOAT,!1,0,0);b.drawArrays(b.TRIANGLES,
0,this.pos_bf.item_n);b.disableVertexAttribArray(c.attrib.aTexCoord);c=this.shdr.white;b.useProgram(c.program);b.enable(b.BLEND);b.blendFunc(b.ONE_MINUS_DST_COLOR,b.ZERO);mat4.identity(this.mv_matrix);mat4.scale(this.mv_matrix,this.mv_matrix,[d,d,1]);mat4.translate(this.mv_matrix,this.mv_matrix,[e,f,0]);b.uniformMatrix4fv(c.uniform.uPMatrix,!1,this.p_matrix);b.uniformMatrix4fv(c.uniform.uMVMatrix,!1,this.mv_matrix);b.bindBuffer(b.ARRAY_BUFFER,this.crosshair_bf);l=a.crosshair;g=l.x;h=l.y;"coronal"!=
this.axis&&("axial"==this.axis?(g=l.x,h=-l.z):"sagittal"==this.axis&&(g=l.z,h=l.y));l=this.plane.bottom/("axial"==this.axis?a.volume.front:a.volume.bottom);g*=this.plane.left/("sagittal"==this.axis?a.volume.front:a.volume.left);h*=l;this.crosshair_arr.set([this.ortho.left,h,0,this.ortho.right,h,0,g,this.ortho.bottom,0,g,this.ortho.top,0]);b.bufferData(b.ARRAY_BUFFER,this.crosshair_arr,b.STATIC_DRAW);b.enableVertexAttribArray(c.attrib.aPosition);b.vertexAttribPointer(c.attrib.aPosition,3,b.FLOAT,!1,
0,0);b.lineWidth(1);b.drawArrays(b.LINES,0,4);c=this.shdr.color;b.useProgram(c.program);b.enable(b.BLEND);b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA);b.enable(b.SCISSOR_TEST);b.scissor(this.viewport.w-this.viewport.w*d,this.viewport.h-this.viewport.h*d,this.viewport.w*d,this.viewport.h*d);mat4.identity(this.mv_matrix);mat4.scale(this.mv_matrix,this.mv_matrix,[d,d,1]);mat4.translate(this.mv_matrix,this.mv_matrix,[e,f,0]);b.uniformMatrix4fv(c.uniform.uPMatrix,!1,this.p_matrix);b.uniformMatrix4fv(c.uniform.uMVMatrix,
!1,this.mv_matrix);b.uniform4fv(c.uniform.vColor,[1,0,0,1]);b.bindBuffer(b.ARRAY_BUFFER,this.minimap_bf);a=this.view_left;d=this.view_bottom;e=this.view_right;f=this.view_top;this.minimap_arr.set([a,d,0,e,d,0,e,f,0,a,f,0,a,d,0]);b.bufferData(b.ARRAY_BUFFER,this.minimap_arr,b.STATIC_DRAW);b.enableVertexAttribArray(c.attrib.aPosition);b.vertexAttribPointer(c.attrib.aPosition,3,b.FLOAT,!1,0,0);b.lineWidth(1);b.drawArrays(b.LINE_STRIP,0,5);b.disable(b.SCISSOR_TEST)};
ViewerCanvas.prototype.updatePlane=function(){this.plane.left=this.ortho.left;this.plane.right=this.ortho.right;this.plane.top=this.ortho.top;this.plane.bottom=this.ortho.bottom;for(var a in this.context.views){var b=this.context.views[a];this.axis in b.panels&&(b=b.panels[this.axis],null!=b.left_border&&(this.plane.left=Math.max(this.plane.left,b.left_border),this.plane.top=Math.min(this.plane.top,b.top_border),this.plane.right=Math.min(this.plane.right,b.right_border),this.plane.bottom=Math.max(this.plane.bottom,
b.bottom_border)))}this.plane.width=this.plane.right-this.plane.left;this.plane.height=this.plane.top-this.plane.bottom;this.context.updateVolume()};ViewerCanvas.prototype.onMousePoint=function(a,b){for(var c=this.tooltip,d=$jscomp.makeIterator(this.active_views),e=d.next();!e.done;e=d.next())if((e=e.value.panels[this.axis])&&e.use_mouse_point)e.onMousePoint(a,b);a=this.mos_win_pos.y-c[0].clientHeight/2-10;c.css("left",this.mos_win_pos.x-c[0].clientWidth/2+"px");c.css("top",a+"px")};
ViewerCanvas.prototype.onMouseOut=function(){this.tooltip.hide()};
ViewerCanvas.prototype.drawScene=function(){var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(this.viewport.x,this.viewport.y,this.viewport.w,this.viewport.h);a.disable(a.DEPTH_TEST);a.clearColor(.3,.3,.3,1);a.clearDepth(1E3);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);a=$jscomp.makeIterator(this.active_views);for(var b=a.next();!b.done;b=a.next())b.value.drawScene(this);this.drawCrosshair();this.drawAxisLabels();this.minimap_enabled&&this.drawMinimap();requestAnimationFrame(this.drawScene.bind(this))};function ViewImage(a,b,c){this.panel=a;this.name=b;this.url=c;this.image=new Image;this.height=this.width=0;this.tex=null;this.is_ready=!1;this.panel.canvas.addToLoadingSet(b);this.image.crossOrigin="anonymous";this.image.onload=this._onImageLoaded.bind(this);this.image.onerror=this._onImageFailed.bind(this);this.image.src=c}
ViewImage.prototype._onImageLoaded=function(){var a=this.panel.canvas.gl;this.width=this.image.width;this.height=this.image.height;this.tex=a.createTexture();a.activeTexture(a.TEXTURE0);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);a.bindTexture(a.TEXTURE_2D,this.tex);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.image);delete this.image;a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);this.panel.canvas.removeFromLoadingSet(this.name);this.is_ready=!0};ViewImage.prototype._onImageFailed=function(){console.log("Texture failed to load: "+this.url);this.tex=null;delete this.image;this.panel.canvas.removeFromLoadingSet(this.name);this.is_ready=!0};function ViewContours(a,b,c){this.panel=a;this.name=b;this.url=c;this.map=null;this.contour_bf={};this.contour_arr={};this.is_ready=!1;this.panel.canvas.addToLoadingSet(b);this.panel.view.context.requestHTTP({method:"GET",url:this.url},this._onContoursLoaded.bind(this),this._onContoursFailed.bind(this))}
ViewContours.prototype._onContoursLoaded=function(a){a=a.data;this.map={};var b=this.panel.canvas.gl,c=this.panel.attrib,d=c&&"horizontal_flip"in c?1:0,e=c&&"vertical_flip"in c?1:0;c=c&&"rotate"in c?c.rotate:0;var f=Math.cos(c),g=Math.sin(c),h;for(h in a){for(var k=[],l=[],t=[],u=$jscomp.makeIterator(a[h]),p=u.next();!p.done;p=u.next()){p=p.value;var v=new Float32Array(2*p.length);if(d||e||c)p=p.map(function(a){return[(d?-1:1)*(a[0]*f-a[1]*g),(e?-1:1)*(a[0]*g+a[1]*f)]});k.push(p);var w=[].concat.apply([],
p);v.set(w);t.push(v);w=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,w);b.bufferData(b.ARRAY_BUFFER,v,b.STATIC_DRAW);w.item_sz=2;w.item_n=p.length/2;l.push(w)}this.contour_bf[h]=l;this.contour_arr[h]=t;this.map[h]=k}this.panel.canvas.removeFromLoadingSet(this.name);this.is_ready=!0};ViewContours.prototype._onContoursFailed=function(a){console.log("contours failed to load: "+this.url);this.contour_arr=this.contour_bf=this.map=null;this.panel.canvas.removeFromLoadingSet(this.name);this.is_ready=!0};function ViewerPanel(a,b){this.view=a;this.canvas=b;this.mv_matrix=mat4.create();this.slice=null;this.slices={};this.slice_holes=new Set;this.pos_arr=this.pos_bf=this.attrib=this.image_h=this.image_w=this.max_slice=this.min_slice=null;this.gl_initialized=!1;this.use_mouse_point=this.bottom_border=this.top_border=this.right_border=this.left_border=null}
ViewerPanel.prototype.setSlice=function(a){var b=this.canvas.axis_prefix+"slice";this.slice=Math.max(this.view.context["min_"+b],Math.min(this.view.context["max_"+b],a));return this.view.context.view_params};
ViewerPanel.prototype.initializeGL=function(){var a=this.canvas.gl;this.texcoord_bf=a.createBuffer();this.texcoord_arr=new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]);a.bindBuffer(a.ARRAY_BUFFER,this.texcoord_bf);a.bufferData(a.ARRAY_BUFFER,this.texcoord_arr,a.STATIC_DRAW);this.texcoord_bf.item_sz=2;this.texcoord_bf.item_n=6;this.gl_initialized=!0};
ViewerPanel.prototype.setImageDimensions=function(a,b){var c=this.canvas,d=c.gl;if(null!==a&&null!==b){this.image_w=a;this.image_h=b;var e=(a>=b?1:a/b)*c.ortho.right;a=(a>=b?b/a:1)*c.ortho.top;null===this.pos_arr&&(this.pos_arr=new Float32Array(18));this.pos_arr.set([-e,a,0,e,a,0,e,-a,0,-e,a,0,e,-a,0,-e,-a,0]);this.left_border=this.pos_arr[0];this.right_border=this.pos_arr[3];this.top_border=this.pos_arr[1];this.bottom_border=this.pos_arr[7];c.updatePlane();null!==d&&(null===this.pos_bf&&(this.pos_bf=
d.createBuffer()),d.bindBuffer(d.ARRAY_BUFFER,this.pos_bf),d.bufferData(d.ARRAY_BUFFER,this.pos_arr,d.STATIC_DRAW),this.pos_bf.item_sz=3,this.pos_bf.item_n=6)}};ViewerPanel.prototype.buildTemplateURL=function(a,b){return""};ViewerPanel.prototype.buildPreviewTemplateURL=function(a,b){return""};ViewerPanel.prototype.getSlice=function(a){};ViewerPanel.prototype.resetSlices=function(){this.slices={}};ViewerPanel.prototype.setUseMousePoint=function(a){this.use_mouse_point=a};
ViewerPanel.prototype.onMousePoint=function(a,b){};function ViewerSingleImagePanel(a,b){ViewerPanel.call(this,a,b)}ViewerSingleImagePanel.prototype=Object.create(ViewerPanel.prototype);
ViewerSingleImagePanel.prototype.getSlice=function(a){if(a in this.slices)return this.slices[a];if(this.slice_holes.has(a)||this.view.empty)return null;var b="/smda/i/"+this.view.context.subject_id,c=this.buildTemplateURL(b,a);b=this.buildPreviewTemplateURL(b,a);return this.slices[a]={index:a,image:new ViewImage(this,this.view.key+":"+a,c),preview:new ViewImage(this,this.view.key+":"+a+":preview",b)}};
ViewerSingleImagePanel.prototype.draw=function(){this.gl_initialized||this.initializeGL();if(null===this.pos_bf)this.setImageDimensions(this.image_w,this.image_h);else{var a=this.view,b=this.canvas,c=a.context,d=b.gl,e=b.shdr.no_alpha_tex,f=this.getSlice(this.slice);if(f&&f.image.is_ready)if(null===f.image.tex)a.onMissingImage();else{a.onLoadedImage();d.disable(d.CULL_FACE);d.useProgram(e.program);d.enable(d.BLEND);d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA);d.uniform1f(e.uniform.uAlpha,a.alpha/
c.max_alpha);mat4.identity(this.mv_matrix);a=c[b.axis_prefix+"scale"]*c[b.axis_prefix+"magnification"];var g=this.attrib,h=(g&&"horizontal_flip"in g?-a:a)*(g&&"xscale"in g?g.xscale:1),k=(g&&"vertical_flip"in g?-a:a)*(g&&"yscale"in g?g.yscale:1);g=g&&"rotate"in g?g.rotate:0;mat4.translate(this.mv_matrix,this.mv_matrix,[-c["pan_"+b.axis_prefix+"x"]*a,-c["pan_"+b.axis_prefix+"y"]*a,0]);mat4.scale(this.mv_matrix,this.mv_matrix,[h,k,1]);mat4.rotate(this.mv_matrix,this.mv_matrix,g,[0,0,1]);d.uniformMatrix4fv(e.uniform.uPMatrix,
!1,b.p_matrix);d.uniformMatrix4fv(e.uniform.uMVMatrix,!1,this.mv_matrix);d.activeTexture(d.TEXTURE0);d.bindTexture(d.TEXTURE_2D,f.image.tex);d.uniform1i(e.uniform.uSampler,0);d.bindBuffer(d.ARRAY_BUFFER,this.pos_bf);d.enableVertexAttribArray(e.attrib.aPosition);d.vertexAttribPointer(e.attrib.aPosition,this.pos_bf.item_sz,d.FLOAT,!1,0,0);d.bindBuffer(d.ARRAY_BUFFER,this.texcoord_bf);d.enableVertexAttribArray(e.attrib.aTexCoord);d.vertexAttribPointer(e.attrib.aTexCoord,this.texcoord_bf.item_sz,d.FLOAT,
!1,0,0);d.drawArrays(d.TRIANGLES,0,this.pos_bf.item_n);d.disableVertexAttribArray(e.attrib.aTexCoord)}else a.onLoadingImage()}};function ViewerMosaicPanel(a,b){ViewerPanel.call(this,a,b)}ViewerMosaicPanel.prototype=Object.create(ViewerPanel.prototype);ViewerMosaicPanel.prototype.buildMosaicTemplateURL=function(a,b,c,d){return""};
ViewerMosaicPanel.prototype.getSlice=function(a){if(a in this.slices)return this.slices[a];if(this.slice_holes.has(a)||this.view.empty)return null;var b="/smda/i/"+this.view.context.subject_id,c=this.buildTemplateURL(b,a);b=this.buildPreviewTemplateURL(b,a);return this.slices[a]={index:a,url:c,mosaic:{},preview:new ViewImage(this,this.view.key+":"+a+":preview",b)}};
ViewerMosaicPanel.prototype.getBSTBin=function(a,b,c,d,e,f){var g=e+c/(2<<f);e+=d/(2<<f);var h=$jscomp.makeIterator([0,0]),k=h.next().value;h=h.next().value;for(var l=1;l<=f;l+=1)k=k<<1|a>g,g+=c/(2<<l)*(a>g?1:-1),h=h<<1|b>e,e+=d/(2<<l)*(b>e?1:-1);return[k+1,h+1]};
ViewerMosaicPanel.prototype.draw=function(){var a=this;this.gl_initialized||this.initializeGL();if(null===this.pos_bf)this.setImageDimensions(this.image_w,this.image_h);else{var b=this.view,c=this.canvas,d=b.context,e=c.gl,f=c.shdr.no_alpha_tex,g=this.getSlice(this.slice);if(g){e.disable(e.CULL_FACE);e.enable(e.BLEND);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);e.useProgram(f.program);e.uniformMatrix4fv(f.uniform.uPMatrix,!1,c.p_matrix);var h=this.attrib,k=d[c.axis_prefix+"scale"]*d[c.axis_prefix+
"magnification"]/b.max_row,l=(h&&"horizontal_flip"in h?-k:k)*(h&&"xscale"in h?h.xscale:1),t=(h&&"vertical_flip"in h?-k:k)*(h&&"yscale"in h?h.yscale:1),u=$jscomp.makeIterator([Math.sign(l),Math.sign(t)]),p=u.next().value;u=u.next().value;var v=$jscomp.makeIterator([d.pan_x*b.max_col,d.pan_y*b.max_row]),w=v.next().value;v=v.next().value;var F=Math.log2(b.max_row),n=Math.pow(2,F),m=c.view_left*n,r=c.view_bottom*n,z=c.view_right*n,B=c.view_top*n;n=[[m,r],[m,B],[z,r],[z,B]];if(h=h&&"rotate"in h?h.rotate:
0){var G=Math.cos(-h),H=Math.sin(-h);n=n.map(function(a){var b=$jscomp.makeIterator(a);a=b.next().value;b=b.next().value;return[a*G-b*H,a*H+b*G]})}var K=c.ortho_xspan*b.max_col,L=c.ortho_yspan*b.max_row,A=n.map(function(b){var d=$jscomp.makeIterator(b);b=d.next().value;d=d.next().value;return a.getBSTBin(b,-d,K,L,c.ortho_xoffset,F)});n=A.map(function(a){return a[0]});A=A.map(function(a){return a[1]});var E=Math.min.apply(Math,[].concat($jscomp.arrayFromIterable(n)));n=Math.max.apply(Math,[].concat($jscomp.arrayFromIterable(n)));
var x=Math.min.apply(Math,[].concat($jscomp.arrayFromIterable(A)));A=Math.max.apply(Math,[].concat($jscomp.arrayFromIterable(A)));r=(B-r+1)*(z-m+1);for(m=1;b.panel_opt&&r/m>b.panel_opt.max_visible_area;)m+=1;e.activeTexture(e.TEXTURE0);e.uniform1i(f.uniform.uSampler,0);e.uniform1f(f.uniform.uAlpha,b.alpha/d.max_alpha);r=$jscomp.makeIterator([Math.cos(h),Math.sin(h)]);var I=r.next().value,J=r.next().value;r=function(a){var b=$jscomp.makeIterator(a);a=b.next().value;b=b.next().value;return[a*I-b*J,
a*J+b*I]};e.enableVertexAttribArray(f.attrib.aPosition);e.enableVertexAttribArray(f.attrib.aTexCoord);(z=g.mosaic[d.level])||(z=g.mosaic[d.level]={});d=Math.ceil(E/m)*m;B=E=!1;for(x=Math.ceil(x/m)*m;x<=A;x+=m)for(var M=-(c.ortho_yspan*(x-b.center_row)+c.ortho_yoffset),C=d;C<=n;C+=m){var q=1==u?x:b.max_row-x+1,y=1==p?C:b.max_col-C+1;if(!(b.row_holes&&b.row_holes.has(q)||b.holes&&b.holes.has([y,q]))){y=[y,q];q=z[y];if(!q){q=b.key+":"+g.index+":"+y;var D=this.buildMosaicTemplateURL(g.url,this.slice,
x,C);q=z[y]=new ViewImage(this,q,D)}q.is_ready?null===q.tex?E|=1:(D=$jscomp.makeIterator(r([c.ortho_xspan*(C-b.center_col)+c.ortho_xoffset,M])),y=D.next().value,D=D.next().value,mat4.identity(this.mv_matrix),mat4.translate(this.mv_matrix,this.mv_matrix,[(y-w)*k,(D-v)*k,0]),mat4.rotate(this.mv_matrix,this.mv_matrix,h,[0,0,1]),mat4.scale(this.mv_matrix,this.mv_matrix,[l*m,t*m,1]),e.uniformMatrix4fv(f.uniform.uMVMatrix,!1,this.mv_matrix),e.bindTexture(e.TEXTURE_2D,q.tex),e.bindBuffer(e.ARRAY_BUFFER,
c.pos_bf),e.vertexAttribPointer(f.attrib.aPosition,c.pos_bf.item_sz,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.texcoord_bf),e.vertexAttribPointer(f.attrib.aTexCoord,this.texcoord_bf.item_sz,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,c.pos_bf.item_n)):B|=1}}e.disableVertexAttribArray(f.attrib.aTexCoord);if(B)b.onLoadingImage();else if(E)b.onMissingImage();else b.onLoadedImage()}else b.onLoadingImage()}};function ViewerLabelPanel(a,b){ViewerSingleImagePanel.call(this,a,b);this.draw_contours=!1}ViewerLabelPanel.prototype=Object.create(ViewerSingleImagePanel.prototype);ViewerLabelPanel.prototype.buildTemplateURL=function(a,b){return[a,"label",this.view.submodality].concat([this.canvas.axis,String(b)]).join("/")};ViewerLabelPanel.prototype.buildPreviewTemplateURL=function(a,b){return[a,"label",this.view.submodality].concat([this.canvas.axis,String(b),"preview"]).join("/")};
ViewerLabelPanel.prototype.buildContourURL=function(a,b){return[a,"contour",this.view.submodality].concat([this.canvas.axis,String(b)]).join("/")};
ViewerLabelPanel.prototype.getSlice=function(a){if(a in this.slices)return this.slices[a];if(this.slice_holes.has(a)||this.view.empty)return null;var b="/smda/i/"+this.view.context.subject_id,c=this.buildTemplateURL(b,a),d=this.buildPreviewTemplateURL(b,a);b=this.buildContourURL(b,a);return this.slices[a]={index:a,image:new ViewImage(this,this.view.key+":"+a,c),preview:new ViewImage(this,this.view.key+":"+a+":preview",d),contours:new ViewContours(this,this.view.key+":"+a,b)}};
ViewerLabelPanel.prototype.onMousePoint=function(a,b){var c=this.getSlice(this.slice);if(c&&c.contours.is_ready&&null!==c.contours.map){var d=this.canvas.tooltip;(a=this.testPoint(c.contours.map,a,b))?(d.show(),d.text(a)):d.hide()}};ViewerLabelPanel.prototype.testPoint=function(a,b,c){for(var d in a)for(var e=a[d],f=[b,c],g=0;g<e.length;g++)if(this.isInside(e[g],f))return d;return null};
ViewerLabelPanel.prototype.isInside=function(a,b){var c=a.length;if(3>c)return!1;var d=[1E3,b[1]],e=0,f=0;do{var g=(f+1)%c;if(this.doIntersect(a[f],a[g],b,d)){if(0==this.orientation(a[f],b,a[g]))return this.onSegment(a[f],b,a[g]);e++}f=g}while(0!=f);return e&1};
ViewerLabelPanel.prototype.doIntersect=function(a,b,c,d){var e=this.orientation(a,b,c),f=this.orientation(a,b,d),g=this.orientation(c,d,a),h=this.orientation(c,d,b);return e!=f&&g!=h||0==e&&this.onSegment(a,c,b)||0==f&&this.onSegment(a,d,b)||0==g&&this.onSegment(c,a,d)||0==h&&this.onSegment(c,b,d)?!0:!1};ViewerLabelPanel.prototype.orientation=function(a,b,c){a=(b[1]-a[1])*(c[0]-b[0])-(b[0]-a[0])*(c[1]-b[1]);return 0==a?0:0<a?1:2};
ViewerLabelPanel.prototype.onSegment=function(a,b,c){return b[0]<=Math.max(a[0],c[0])&&b[0]>=Math.min(a[0],c[0])&&b[1]<=Math.max(a[1],c[1])&&b[1]>=Math.min(a[1],c[1])?!0:!1};
ViewerLabelPanel.prototype.draw=function(){this.gl_initialized||this.initializeGL();if(null===this.pos_bf)this.setImageDimensions(this.image_w,this.image_h);else{var a=this.view,b=this.canvas,c=a.context,d=b.gl,e=b.shdr.no_alpha_tex,f=this.getSlice(this.slice);if(f&&f.image.is_ready)if(null===f.image.tex)a.onMissingImage();else{a.onLoadedImage();d.disable(d.CULL_FACE);d.useProgram(e.program);d.enable(d.BLEND);d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA);d.uniform1f(e.uniform.uAlpha,a.alpha/c.max_alpha);
mat4.identity(this.mv_matrix);a=c[b.axis_prefix+"scale"]*c[b.axis_prefix+"magnification"];var g=c["pan_"+b.axis_prefix+"x"];c=c["pan_"+b.axis_prefix+"y"];var h=this.attrib,k=(h&&"horizontal_flip"in h?-a:a)*(h&&"xscale"in h?h.xscale:1),l=(h&&"vertical_flip"in h?-a:a)*(h&&"yscale"in h?h.yscale:1);h=h&&"rotate"in h?h.rotate:0;mat4.translate(this.mv_matrix,this.mv_matrix,[-g*a,-c*a,0]);mat4.scale(this.mv_matrix,this.mv_matrix,[k,l,1]);mat4.rotate(this.mv_matrix,this.mv_matrix,h,[0,0,1]);d.uniformMatrix4fv(e.uniform.uPMatrix,
!1,b.p_matrix);d.uniformMatrix4fv(e.uniform.uMVMatrix,!1,this.mv_matrix);d.activeTexture(d.TEXTURE0);d.bindTexture(d.TEXTURE_2D,f.image.tex);d.uniform1i(e.uniform.uSampler,0);d.bindBuffer(d.ARRAY_BUFFER,this.pos_bf);d.enableVertexAttribArray(e.attrib.aPosition);d.vertexAttribPointer(e.attrib.aPosition,this.pos_bf.item_sz,d.FLOAT,!1,0,0);d.bindBuffer(d.ARRAY_BUFFER,this.texcoord_bf);d.enableVertexAttribArray(e.attrib.aTexCoord);d.vertexAttribPointer(e.attrib.aTexCoord,this.texcoord_bf.item_sz,d.FLOAT,
!1,0,0);d.drawArrays(d.TRIANGLES,0,this.pos_bf.item_n);d.disableVertexAttribArray(e.attrib.aTexCoord);d.bindTexture(d.TEXTURE_2D,null);if(this.draw_contours&&null!==f.contours.contour_bf){e=b.shdr.color;d.useProgram(e.program);mat4.identity(this.mv_matrix);mat4.translate(this.mv_matrix,this.mv_matrix,[-g*a,-c*a,0]);mat4.scale(this.mv_matrix,this.mv_matrix,[k,l,1]);d.uniform4fv(e.uniform.vColor,[1,1,1,1]);d.uniformMatrix4fv(e.uniform.uPMatrix,!1,b.p_matrix);d.uniformMatrix4fv(e.uniform.uMVMatrix,!1,
this.mv_matrix);for(var t in f.contours.contour_bf)for(b=$jscomp.makeIterator(f.contours.contour_bf[t]),a=b.next();!a.done;a=b.next())a=a.value,d.bindBuffer(d.ARRAY_BUFFER,a),d.enableVertexAttribArray(e.attrib.aPosition),d.vertexAttribPointer(e.attrib.aPosition,a.item_sz,d.FLOAT,!1,0,0),d.drawArrays(d.LINE_STRIP,0,a.item_n)}}else a.onLoadingImage()}};function View(a,b,c,d,e,f,g){this.context=a;this.id=b;this.view_class=c;this.modality=d;this.submodality=e;this.key=this.modality+(this.submodality?"."+this.submodality:"");this.prefix=this.modality+(this.submodality?"_"+this.submodality:"")+"_";this.name=f;this.active=!1;this.selectable=!0;this.show_alpha=!1;a=this.context.view_params;b=this.prefix+"_a";this.alpha=b in a?a[b]:this.context.max_alpha;this.context.setScopeVariable(b,this.alpha);this.panels=g;this.img_url=this.layer_opt=this.panel_opt=
null;this.empty=!1;this.visible=!0;this.bg_class={};this.text_class={};this.tooltip=""}View.prototype.loadResource=function(a){};View.prototype.checkPanBounds=function(a){};View.prototype.getLayer=function(){return this.context.layers.indexOf(this.id)};View.prototype.activate=function(){this.show_alpha=this.active=!0;for(var a in this.panels)this.panels[a]&&this.context.canvas[a].activateView(this)};
View.prototype.deactivate=function(){this.show_alpha=this.active=!1;for(var a in this.panels)this.panels[a]&&this.context.canvas[a].deactivateView(this)};View.prototype.setAlpha=function(a){var b=this.context.view_params,c=this.prefix+"_a";b[c]=this.alpha=Math.max(this.context.min_alpha,Math.min(this.context.max_alpha,a));this.context.setScopeVariable(c,this.alpha);return b};View.prototype.setSlice=function(a,b){return(a=this.panels[a])?a.setSlice(b):this.context.view_params};
View.prototype._createPanelAttrib=function(a){if(!a)return null;a=Object.assign({},a);if(a.rotate){var b=$jscomp.makeIterator(a.rotate.split(" ")),c=b.next().value;b=b.next().value;b=parseInt(b,10)*Math.PI/180;a.rotate=("right"==c?-1:1)*b}return a};View.prototype.resetSlices=function(){for(var a in this.panels){var b=this.panels[a];b&&b.resetSlices()}this.bg_class={};this.text_class={};this.tooltip=""};View.prototype.drawScene=function(a){(a=this.panels[a.axis])&&a.draw()};
View.prototype.getLayerImageURL=function(){return this.view_class.img_url};View.prototype.getBackgroundClass=function(){return this.bg_class};View.prototype.getTooltip=function(){return this.tooltip};View.prototype.getTextClass=function(){return this.text_class};View.prototype._sliceAvailableCSS=function(){delete this.bg_class.unavailable_view;delete this.text_class.unavailable_view;this.context.deactivateSpinner(this.spinner_key);this.tooltip=""};
View.prototype._sliceLoadingCSS=function(){delete this.bg_class.unavailable_view;delete this.text_class.unavailable_view;this.tooltip="Loading..."};View.prototype._sliceUnavailableCSS=function(){this.bg_class.unavailable_view=!0;this.text_class.unavailable_view=!0;this.tooltip="Slice unavailable"};View.prototype.onLoadedImage=function(){"unavailable_view"in this.bg_class&&this._sliceAvailableCSS()};View.prototype.onLoadingImage=function(){this.onLoadedImage()};
View.prototype.onMissingImage=function(){"unavailable_view"in this.bg_class||this._sliceUnavailableCSS()};function ViewerViewClass(a,b,c){this.context=a;this.key=b;this.name=c;this.views={};this.img_url="img/webviewer/";switch(this.key){case "block":this.img_url+="red_circle.png";break;case "hist":this.img_url+="green_circle.png";break;case "accessory-overlay":this.img_url+="yellow_circle.png";break;case "mri":this.img_url+="blue_circle.png"}this.active=!1;this.default_views=new Set}
ViewerViewClass.prototype.setViews=function(a){a=$jscomp.makeIterator(a);for(var b=a.next();!b.done;b=a.next())b=b.value,this.views[b.key]=b};ViewerViewClass.prototype.setViewDefault=function(a){this.default_views.add(a)};ViewerViewClass.prototype.loadResource=function(){for(var a in this.views)this.views[a].loadResource(this.context.resource)};
ViewerViewClass.prototype.updateVisibilityFromViews=function(){this.active=Object.values(this.views).some(function(a){return a.active});for(var a in this.views){var b=this.views[a];b.visible=this.active&&!b.empty}};ViewerViewClass.prototype.updateVisibility=function(){for(var a in this.views){var b=this.views[a];b.visible=this.active&&!b.empty;b.active&=b.visible}};
ViewerViewClass.prototype.activateDefaultViews=function(){if(this.active){for(var a=$jscomp.makeIterator(this.default_views),b=a.next();!b.done;b=a.next())this.views[b.value].deactivate();if(this.default_views.size)for(a=$jscomp.makeIterator(this.default_views),b=a.next();!b.done;b=a.next())b=this.views[b.value],b.empty||b.activate()}};
ViewerViewClass.prototype.setVivoAndSession=function(a,b,c){for(var d in this.views){var e=this.views[d];"MR"==e.modality?e.setVivoAndSession(a,b,c):"glyph"==e.modality&&e.setVivoAndSession(a,b)}};ViewerViewClass.prototype.getLayerImageURL=function(){return this.img_url};function ViewerBlockPanel(a,b){ViewerSingleImagePanel.call(this,a,b)}ViewerBlockPanel.prototype=Object.create(ViewerSingleImagePanel.prototype);ViewerBlockPanel.prototype.buildTemplateURL=function(a,b){return[a,this.view.modality,String(b)].join("/")};ViewerBlockPanel.prototype.buildPreviewTemplateURL=function(a,b){return[a,this.view.modality,String(b),"preview"].join("/")};function BlockView(a,b,c){View.call(this,a,b,c,"block","","Block",{coronal:new ViewerBlockPanel(this,a.canvas.coronal)})}
BlockView.prototype=Object.create(View.prototype);BlockView.prototype.loadResource=function(a){var b=a.modes.block||{},c=this.panels.coronal;this.empty=a.modes.block?0:1;c.min_slice=b.min_slice||null;c.max_slice=b.max_slice||null;c.setImageDimensions(b.image_w||1,b.image_h||1);c.slice_holes=new Set(b.slice_holes||[]);this.image_w=b.image_w||1;this.image_h=b.image_h||1;c.attrib=this._createPanelAttrib(b.attrib);this.resetSlices()};var ViewHistPanel=function(a,b){ViewerMosaicPanel.call(this,a,b)};ViewHistPanel.prototype=Object.create(ViewerMosaicPanel.prototype);ViewHistPanel.prototype.buildTemplateURL=function(a,b){return[a,this.view.modality,this.view.stain,String(b)].join("/")};ViewHistPanel.prototype.buildPreviewTemplateURL=function(a,b){return[a,this.view.modality,this.view.stain,String(b),String(this.view.context.level),"preview"].join("/")};
ViewHistPanel.prototype.buildMosaicTemplateURL=function(a,b,c,d){return[a,String(this.view.context.level),String(c),String(d)].join("/")};function HistView(a,b,c){View.call(this,a,b,c,"hist","","Histology",{coronal:new ViewHistPanel(this,a.canvas.coronal)})}HistView.prototype=Object.create(View.prototype);
HistView.prototype.loadResource=function(a){var b=this.context.view_params;a=(this.empty=a.modes.hist?0:1)?{}:a.modes.hist;this.stains={};this.stain_names=[];for(var c in a){this.stain_names.push(c);var d=Object.assign({},a[c]);d.slice_holes=new Set(d.slice_holes||[]);d.min_level=null;d.max_level=null;d.levels={};d.attrib=d.attrib||{};var e=a[c].levels,f;for(f in e){var g=parseInt(f,10),h=Object.assign({},e[f]);h.row_holes=h.row_holes?new Set(h.row_holes):null;h.holes=h.holes?new Set(h.holes.map(function(a){return a.join(",")})):
null;d.levels[g]=h;if(null==d.min_level||g<d.min_level)d.min_level=g;if(null==d.max_level||g>d.max_level)d.max_level=g}this.stains[c]=d}this.empty|=0==this.stain_names.length;this.layer_opt={hist_stains:this.stain_names};this.panel_opt={max_visible_area:100};this.setStain(b.stain in this.stains?b.stain:this.stain_names.length?this.stain_names[0]:null,{update_bounds:!1})};
HistView.prototype.setStain=function(a,b){var c=this.context.view_params,d=this.context.canvas.axis_prefix,e=this.stains[a]||{},f=this.panels.coronal;c.stain=this.stain=a;this.context.setScopeVariable("stain",this.stain);f.min_slice=e.min_slice||null;f.max_slice=e.max_slice||null;f.setImageDimensions(e.image_w||null,e.image_h||null);this.mag_factor=e.mag_factor||4;f.slice=Math.max(f.min_slice,Math.min(f.max_slice,f.slice||Math.floor((f.min_slice+f.max_slice)/2)));this.context.setScopeVariable(d+"slice",
f.slice);this.min_level=e.min_level||2;this.max_level=e.max_level||5;this.levels=e.levels||{};f.attrib=this._createPanelAttrib(e.attrib);b&&!b.update_bounds||this.context.checkSliceBounds("coronal");this.resetSlices();return c};
HistView.prototype.checkPanBounds=function(a){a=this.context.view_params;var b=this.level=this.context.level;this.scale=this.context.scale;this.magnification=this.context.magnification;b=this.levels[b]||{};if(0===b.length)return a;this.min_row=b.min_row;this.max_row=b.max_row;this.min_col=b.min_col;this.max_col=b.max_col;this.row_holes=b.row_holes;this.holes=b.holes;this.block_image_w=b.image_w;this.block_image_h=b.image_h;this.image_w=(this.max_col-this.min_col+1)*this.block_image_w;this.image_h=
(this.max_row-this.min_row+1)*this.block_image_h;this.center_row=this.max_row/2;this.center_col=this.max_col/2};function ViewerMRPanel(a,b){ViewerSingleImagePanel.call(this,a,b)}ViewerMRPanel.prototype=Object.create(ViewerSingleImagePanel.prototype);ViewerMRPanel.prototype.buildTemplateURL=function(a,b){return[a,"MR",this.view.submodality,this.view.vivo,String(this.view.session)].concat(this.view.volume?[this.view.volume]:[]).concat([this.canvas.axis,String(b)]).join("/")};
ViewerMRPanel.prototype.buildPreviewTemplateURL=function(a,b){return[a,"MR",this.view.submodality,this.view.vivo,String(this.view.session)].concat(this.view.volume?[this.view.volume]:[]).concat([this.canvas.axis,String(b),"preview"]).join("/")};function MRView(a,b,c,d,e){View.call(this,a,b,c,"MR",d,e,{coronal:new ViewerMRPanel(this,a.canvas.coronal),axial:new ViewerMRPanel(this,a.canvas.axial),sagittal:new ViewerMRPanel(this,a.canvas.sagittal)})}MRView.prototype=Object.create(View.prototype);
MRView.prototype.loadResource=function(a){this.resetSlices();var b=this.context.view_params;a=(this.empty="MR"in a.modes&&a.modes.MR?this.submodality in a.modes.MR&&a.modes.MR[this.submodality]?0:1:1)?{}:a.modes.MR[this.submodality];this.volume_name=(this.has_volumes=a.has_volumes)?this.submodality+"_vol":null;this.volume=this.has_volumes?b[this.volume_name]:"";this.volumes=null;this.sessions=Object.assign({},a.sessions);this.session_names=a.session_names?a.session_names.slice():[];if(0==this.context.session_names.length){a=
$jscomp.makeIterator(this.session_names);for(var c=a.next();!c.done;c=a.next())this.context.session_names.push(c.value)}this.empty|=0==this.session_names.length;this.layer_opt={sessions:this.session_names};if(this.has_volumes){this.volumes=new Set;for(var d in this.sessions){a=this.sessions[d];for(var e in a){c=a[e];for(var f in c)this.volumes.add(f)}}this.layer_opt.volumes=Array.from(this.volumes)}this.setVivoAndSession(b.vivo,b.session,this.volume,{update_bounds:!1})};
MRView.prototype.setSessionName=function(a,b,c){null===b&&(b=this.volume);if(-1!=a.indexOf("-")){var d=$jscomp.makeIterator(a.split("-",2));a=d.next().value;d=d.next().value;return this.setVivoAndSession(a,d,b,c)}return this.context.view_params};
MRView.prototype.setVivoAndSession=function(a,b,c,d){var e=this.context,f=e.view_params;if(b in this.sessions&&a in this.sessions[b]&&(!this.has_volumes||c in this.sessions[b][a])){this.session_name=a+"-"+b;this.session=b;this.vivo=a;this.volume=this.has_volumes?c:null;a=this.sessions[this.session][this.vivo];this.has_volumes&&(a=a[this.volume],f[this.volume_name]=c,e.setScopeVariable(this.volume_name,this.volume));for(var g in this.panels)if(c=this.panels[g])b=a[g]||{},c.min_slice=b.min_slice||null,
c.max_slice=b.max_slice||null,c.setImageDimensions(b.image_w||null,b.image_h||null),c.slice_holes=new Set,c.attrib=this._createPanelAttrib(b.attrib),d&&!d.update_bounds||e.checkSliceBounds(g);this.resetSlices()}return f};function LabelView(a,b,c,d,e){View.call(this,a,b,c,"label",d,e,{coronal:new ViewerLabelPanel(this,a.canvas.coronal),axial:new ViewerLabelPanel(this,a.canvas.axial),sagittal:new ViewerLabelPanel(this,a.canvas.sagittal)})}LabelView.prototype=Object.create(View.prototype);
LabelView.prototype.loadResource=function(a){a=(this.empty="labels"in a.modes&&a.modes.labels?this.submodality in a.modes.labels&&a.modes.labels[this.submodality]?0:1:1)?{}:a.modes.labels[this.submodality];for(var b in this.panels){var c=this.panels[b];if(c){var d=a[b]||{};c.min_slice=d.min_slice||null;c.max_slice=d.max_slice||null;c.setImageDimensions(d.image_w||null,d.image_h||null);c.slice_holes=new Set;c.attrib=this._createPanelAttrib(d.attrib);c.setUseMousePoint("MR"==this.submodality||"roi"==
this.submodality)}}this.resetSlices()};var ViewGlyphPanel=function(a,b){ViewerMosaicPanel.call(this,a,b)};ViewGlyphPanel.prototype=Object.create(ViewerMosaicPanel.prototype);ViewGlyphPanel.prototype.buildTemplateURL=function(a,b){return[a,this.view.modality,this.view.submodality,this.view.vivo,String(this.view.session),String(b)].join("/")};ViewGlyphPanel.prototype.buildPreviewTemplateURL=function(a,b){return[a,this.view.modality,this.view.submodality,this.view.vivo,String(this.view.session),String(b),"preview"].join("/")};
ViewGlyphPanel.prototype.buildMosaicTemplateURL=function(a,b,c,d){return[a,String(c),String(d)].join("/")};function GlyphView(a,b,c,d,e){View.call(this,a,b,c,"glyph",d,e,{coronal:new ViewGlyphPanel(this,a.canvas.coronal)})}GlyphView.prototype=Object.create(View.prototype);
GlyphView.prototype.loadResource=function(a){this.resetSlices();var b=this.context.view_params;this.empty="glyphs"in a.modes&&a.modes.glyphs?this.submodality in a.modes.glyphs&&a.modes.glyphs[this.submodality]?0:1:1;this.sessions=Object.assign({},(this.empty?{}:a.modes.glyphs[this.submodality]).sessions||{});this.session_names=kvMap(this.sessions,function(a,b){return kvMap(b,function(b,c){return b+"-"+a})}).reduce(function(a,b){return a.concat(b)},[]);if(0==this.context.session_names.length){a=$jscomp.makeIterator(this.session_names);
for(var c=a.next();!c.done;c=a.next())this.context.session_names.push(c.value)}this.layer_opt={sessions:this.session_names};this.panel_opt={max_visible_area:4096};this.setVivoAndSession(b.vivo,b.session,{update_bounds:!1})};GlyphView.prototype.setSessionName=function(a,b){if(-1!=a.indexOf("-")){var c=$jscomp.makeIterator(a.split("-",2));a=c.next().value;c=c.next().value;return this.setVivoAndSession(a,c,b)}return this.context.view_params};
GlyphView.prototype.setVivoAndSession=function(a,b,c){var d=this.context,e=d.view_params;b in this.sessions&&a in this.sessions[b]&&(this.session_name=a+"-"+b,this.session=b,this.vivo=a,a=this.sessions[this.session][this.vivo],b=this.panels.coronal,b.min_slice=a.min_slice||null,b.max_slice=a.max_slice||null,b.setImageDimensions(a.image_w||null,a.image_h||null),b.slice_holes=new Set,this.min_row=a.min_row||0,this.max_row=a.max_row||0,this.min_col=a.min_col||0,this.max_col=a.max_col||0,this.center_row=
this.max_row/2,this.center_col=this.max_col/2,this.image_w=a.image_w||1,this.image_h=a.image_h||1,b.attrib=this._createPanelAttrib(a.attrib),c&&!c.update_bounds||d.checkSliceBounds("coronal"),this.resetSlices());return e};function ViewerAMRPanel(a,b){ViewerSingleImagePanel.call(this,a,b)}ViewerAMRPanel.prototype=Object.create(ViewerSingleImagePanel.prototype);ViewerAMRPanel.prototype.buildTemplateURL=function(a,b){return[a,"aMR",this.view.submodality].concat(this.view.volume?[this.view.volume]:[]).concat([this.canvas.axis,String(b)]).join("/")};
ViewerAMRPanel.prototype.buildPreviewTemplateURL=function(a,b){return[a,"aMR",this.view.submodality].concat(this.view.volume?[this.view.volume]:[]).concat([this.canvas.axis,String(b),"preview"]).join("/")};function AggregateMRView(a,b,c,d,e){View.call(this,a,b,c,"aggregateMR",d,e,{coronal:new ViewerAMRPanel(this,a.canvas.coronal),axial:new ViewerAMRPanel(this,a.canvas.axial),sagittal:new ViewerAMRPanel(this,a.canvas.sagittal)})}AggregateMRView.prototype=Object.create(View.prototype);
AggregateMRView.prototype.loadResource=function(a){this.resetSlices();var b=this.context.view_params;a=(this.empty="aggregateMR"in a.modes&&a.modes.aggregateMR?this.submodality in a.modes.aggregateMR&&a.modes.aggregateMR[this.submodality]?0:1:1)?{}:a.modes.aggregateMR[this.submodality];this.volume_name=(this.has_volumes=a.has_volumes)?this.submodality+"_vol":null;this.volume=this.has_volumes?b[this.volume_name]:"";b=a.all_sessions||{};for(var c in this.panels)if(a=this.panels[c]){var d=b[c]||{};a.min_slice=
d.min_slice||null;a.max_slice=d.max_slice||null;a.setImageDimensions(d.image_w||null,d.image_h||null);a.slice_holes=new Set;a.attrib=this._createPanelAttrib(d.attrib);a.attrib&&"thickness_in_mm"in a.attrib&&(this.context.has_thickness=!0,this.context.thickness[c]=a.attrib.thickness_in_mm)}this.resetSlices()};function ViewerToolset(a){this.context=a;this.body=$(document.body);this.active_tool=null}ViewerToolset.prototype.isActiveTool=function(a){return this.active_tool===a};
ViewerToolset.prototype.activateCrosshairTool=function(){this.active_tool="crosshair";var a=this,b=this.context,c;for(c in b.canvas)(function(b){var c=b.element;c.removeClass("cursorPan");c.removeClass("cursorPanning");c.removeClass("cursorZoomIn");c.removeClass("cursorZoomOut");c.addClass("cursorCrosshair");a._setCrosshairToolForCanvas(b)})(b.canvas[c]);this.body.off("mouseup");this.body.mouseup(function(){for(var a in b.canvas){var c=b.canvas[a];c.element.off("mousemove",c._crosshairTrack)}})};
ViewerToolset.prototype.centerCrosshair=function(){this.context.crosshairCenter()};ViewerToolset.prototype.centerPan=function(){this.context.panCenter("coronal");this.context.panCenter("axial");this.context.panCenter("sagittal")};
ViewerToolset.prototype._setCrosshairToolForCanvas=function(a){var b=this.context,c=a.element;c.off();a._crosshairTrack=function(){b.setCrosshair(a,a.mos_pos.x,a.mos_pos.y)};c.mousemove(a.onDefaultMouseMove.bind(a));c.mouseout(a.onDefaultMouseOut.bind(a));c.mousedown(function(d){b.setCrosshair(a,a.mos_pos.x,a.mos_pos.y);c.mousemove(a.onDefaultMouseMove.bind(a));c.mousemove(a._crosshairTrack)});this.setScrollWheelZoom(a)};
ViewerToolset.prototype.activatePanTool=function(){this.active_tool="pan";var a=this,b=this.context,c;for(c in b.canvas)(function(b){b.element.removeClass("cursorCrosshair");b.element.removeClass("cursorZoomIn");b.element.removeClass("cursorZoomOut");b.element.addClass("cursorPan");a._setPanToolForCanvas(b)})(b.canvas[c]);this.body.off("mouseup");this.body.mouseup(function(){for(var a in b.canvas){var c=b.canvas[a];c.element.removeClass("cursorPanning");c.element.off("mousemove",c._panTrack);c.element.off("mousemove",
c._minimapPanTrack)}})};
ViewerToolset.prototype._setPanToolForCanvas=function(a){var b=this.context,c=a.element;c.off();a._panTrack=function(){b.addPan(a.axis,a.prev_mos_pos.x-a.mos_pos.x,a.prev_mos_pos.y-a.mos_pos.y);Object.assign(a.prev_mos_pos,a.mos_pos)};a._minimapTrack=function(){var b=$jscomp.makeIterator([0,0]),e=b.next().value;b=b.next().value;a.minimap_enabled&&(e=a.ortho.right-a.ortho_xspan*a.minimap_size,b=a.ortho.top-a.ortho_yspan*a.minimap_size);a.minimap_enabled&&a.mos_pos.x>=e&&a.mos_pos.y>=b?(c.removeClass("cursorPan"),
c.addClass("pointer")):(c.addClass("cursorPan"),c.removeClass("pointer"))};c.mousemove(a.onDefaultMouseMove.bind(a));c.mouseout(a.onDefaultMouseOut.bind(a));c.mousemove(a._minimapTrack);a._minimapPanTrack=function(){var c=$jscomp.makeIterator([0,0]),e=c.next().value;c=c.next().value;a.minimap_enabled&&(e=a.ortho.right-a.ortho_xspan*a.minimap_size,c=a.ortho.top-a.ortho_yspan*a.minimap_size);a.minimap_enabled&&a.mos_pos.x>=e&&a.mos_pos.y>=c&&b.setPan(a.axis,a.ortho_xoffset+(a.mos_pos.x-e)/a.minimap_size*
a.ortho_xspan,a.ortho_yoffset+(a.mos_pos.y-c)/a.minimap_size*a.ortho_yspan)};c.mousedown(function(){var d=$jscomp.makeIterator([0,0]),e=d.next().value;d=d.next().value;Object.assign(a.prev_mos_pos,a.mos_pos);a.minimap_enabled&&(e=a.ortho.right-a.ortho_xspan*a.minimap_size,d=a.ortho.top-a.ortho_yspan*a.minimap_size);a.minimap_enabled&&a.mos_pos.x>=e&&a.mos_pos.y>=d?(b.setPan(a.axis,a.ortho_xoffset+(a.mos_pos.x-e)/a.minimap_size*a.ortho_xspan,a.ortho_yoffset+(a.mos_pos.y-d)/a.minimap_size*a.ortho_yspan),
c.mousemove(a._minimapPanTrack)):(c.addClass("cursorPanning"),c.mousemove(a._panTrack))});this.setScrollWheelZoom(a)};
ViewerToolset.prototype.setScrollWheelZoom=function(a){var b=this.context;a.element.mousewheel(function(c){var d=$jscomp.makeIterator([0,0]),e=d.next().value;d=d.next().value;a.minimap_enabled&&(e=a.ortho.right-a.ortho_xspan*a.minimap_size,d=a.ortho.top-a.ortho_yspan*a.minimap_size);a.minimap_enabled&&a.mos_pos.x>=e&&a.mos_pos.y>=d?0<c.deltaY?b.incrementSlice(a.axis):0>c.deltaY&&b.decrementSlice(a.axis):0<c.deltaY?b.incrementZoom(a.axis):0>c.deltaY&&b.decrementZoom(a.axis);return!1})};
ViewerToolset.prototype.activateMinimapTool=function(){this.context.toggleMinimap()};ViewerToolset.prototype.activateZoomInTool=function(){this.active_tool="zoom_in";var a=this,b=this.context,c;for(c in b.canvas)(function(c){var d=c.element;d.removeClass("cursorPan");d.removeClass("cursorPanning");d.removeClass("cursorCrosshair");d.removeClass("cursorZoomOut");d.addClass("cursorZoomIn");d.off();d.mousedown(function(a){b.incrementZoom(c.axis)});a.setScrollWheelZoom(c)})(b.canvas[c])};
ViewerToolset.prototype.activateZoomOutTool=function(){this.active_tool="zoom_out";var a=this,b=this.context,c;for(c in b.canvas)(function(c){var d=c.element;d.removeClass("cursorPan");d.removeClass("cursorPanning");d.removeClass("cursorCrosshair");d.removeClass("cursorZoomIn");d.addClass("cursorZoomOut");d.off();d.mousedown(function(a){b.decrementZoom(c.axis)});a.setScrollWheelZoom(c)})(b.canvas[c])};
ViewerToolset.prototype._processPageCoordinates=function(a){a=a||window.event;if(null==a.pageX&&null!=a.clientX){var b=a.target&&a.target.ownerDocument||document,c=b.documentElement;b=b.body;a.pageX=a.clientX+(c&&c.scrollLeft||b&&b.scrollLeft||0)-(c&&c.clientLeft||b&&b.clientLeft||0);a.pageY=a.clientY+(c&&c.scrollTop||b&&b.scrollTop||0)-(c&&c.clientTop||b&&b.clientTop||0)}return a};ViewerToolset.prototype.initialize=function(){this.activateCrosshairTool()};function ViewerContext(a,b){this.canvas_container=a;this.getSavedValue=b.getSavedValue;this.setSavedValue=b.setSavedValue;this.hasSavedValue=b.hasSavedValue;this.getScopeVariable=b.getScopeVariable;this.setScopeVariable=b.setScopeVariable;this.createSpinnerElement=b.createSpinnerElement;this.activateSpinner=b.activateSpinner;this.deactivateSpinner=b.deactivateSpinner;this.getSubjectInfo=b.getSubjectInfo;this.updatePageState=b.updatePageState;this.requestHTTP=b.requestHTTP;this.subject_resources={};
this.subjects=[];this.modes=[];this.stains=[];this.canvas={};this.canvas_n=0;this.canvas_rows=[];this.panels={};this.panel_n=0;this.crosshair={x:0,y:0,z:0};this.proc_names=[];this.session_names=[];this.session_name="";this.selectable_views=new Set;this.valid_views=new Set;this.views={};this.view_classes={};this.layers=[];this.toolset=new ViewerToolset(this);this.half_pi=Math.PI/2;this.axes=["coronal","axial","sagittal"];this.axis_prefixes=["","ax_","sa_"];this.volume={left:0,right:0,top:0,bottom:0,
front:0,back:0,width:0,height:0,depth:0};this.has_thickness=!1;this.thickness={coronal:0,axial:0,sagittal:0};document.getElementById("mouseoverTooltip")}ViewerContext.prototype.setResource=function(a,b){this.resource=a;this.view_params=b;this.subjects=a.subjects;this.subject_id=a.id;this.subject_resources[this.subject_id]=this.resource;this.setScopeVariable("subject",this.subject_id);this.modes=Object.keys(this.resource.modes);return this.initializeViews(b)};
ViewerContext.prototype.setCanvasElements=function(){var a=Math.pow(2,Math.ceil(Math.log2(this.canvas_n)));a=Math.ceil(a/Math.floor(Math.sqrt(a)));var b=null,c=0,d=0,e;for(e in this.canvas){var f=this.canvas[e];0==c%a&&(b={index:d,element:angular.element("<div class='panelRow'></div>"),canvas:[]},b.element.hide(),this.canvas_rows.push(b),this.canvas_container.append(b.element),d++);var g=angular.element('<div class="panelParent"></div>'),h=angular.element('<div class="panelSpinner"></div>');h.append(f.spinner);
g.hide();g.append(f.element);g.append(h);g.append(f.tooltip);b.canvas.push(f);b.element.append(g);f.setHTMLElementParents(g,b);f.initializeGL();c++}this.toolset.initialize()};ViewerContext.prototype.clearCanvasElements=function(){this.canvas_container.empty();this.canvas={};this.canvas_n=0;this.panels={};this.panel_n=0};ViewerContext.prototype.getSubjects=function(){return this.subjects};
ViewerContext.prototype.initializeViews=function(a){var b=this;this.min_alpha=0;this.max_alpha=100;var c=function(a){return isNumber(a)?Math.max(b.min_alpha,Math.min(b.max_alpha,a)):b.max_alpha};a=this.view_params={subject:this.subject_id,view:a.view||"BL",layers:a.layers||"",slice:a.slice||0,ax_slice:a.ax_slice||0,sa_slice:a.sa_slice||0,zoom:Number.isInteger(a.zoom)?a.zoom:1,ax_zoom:Number.isInteger(a.ax_zoom)?a.ax_zoom:1,sa_zoom:Number.isInteger(a.sa_zoom)?a.sa_zoom:1,px:a.px||"0",py:a.py||"0",
pz:a.pz||"0",x:a.x||"0",y:a.y||"0",ax_x:a.ax_x||"0",ax_y:a.ax_y||"0",sa_x:a.sa_x||"0",sa_y:a.sa_y||"0",stain:a.stain||"BDA",proc:a.proc||"T2",session:a.session||1,param:a.param||"",vivo:a.vivo||"exvivo",Diffusion_tensor_vol:a.Diffusion_tensor_vol||"1",RA_vol:a.RA_vol||"1",VR_vol:a.VR_vol||"1",label:a.label||"roi",glyph:a.glyph||"DTI",block_a:c(a.block_a),hist_a:c(a.hist_a),MR_a:c(a.MR_a),label_a:c(a.label_a),glyph_a:c(a.glyph_a)};this.crosshair={x:parseFloatWithDefault(a.px),y:parseFloatWithDefault(a.py),
z:parseFloatWithDefault(a.pz)};this.clearCanvasElements();this.canvas_n=0;for(var d in this.axes)c=this.axes[d],this.canvas[c]=new ViewerCanvas(this,c,this.axis_prefixes[d]),this.canvas_n++;this.min_zoom=1;this.max_zoom=10;this.max_pan=.5;this.min_pan=-.5;for(var e in this.axes){c=this.axes[e];d=this.axis_prefixes[e];c.charAt(0).toUpperCase();c.slice(1);c=d+"zoom";a[c]=this[c]=Math.max(this.min_zoom,Math.min(this.max_zoom,a[c]));this.setScopeVariable(c,this[c]);c=d+"slice";this[c]=a[c];this.setScopeVariable(c,
this[c]);c="pan_"+d+"x";var f="pan_"+d+"y";this[c]=parseFloatWithDefault(a[d+"x"]);this[f]=parseFloatWithDefault(a[d+"y"]);this.setScopeVariable(d+"x",this[c]+"");this.setScopeVariable(d+"y",this[f]+"")}this.session_names=[];this.session_name=a.vivo+"-"+a.session;this.max_level=5;this.min_level=2;this.mag_factor=4;this.max_mag=Math.pow(this.mag_factor,this.max_level-this.min_level);e=new ViewerViewClass(this,"accessory-overlay","Accessory Overlays");e.setViews([new GlyphView(this,"G1",e,"CSD","CSD glyphs"),
new GlyphView(this,"G2",e,"DTI","DTI glyphs"),new LabelView(this,"L1",e,"roi","ROI Label"),new LabelView(this,"L2",e,"BDAcount","BDA Count Label"),new LabelView(this,"L3",e,"MR","MR Label")]);e.setViewDefault("label.BDAcount");this.addViewClass(e);this.has_thickness=!1;e=new ViewerViewClass(this,"mri","MRI");e.setViews([new MRView(this,"T2",e,"T2","T2"),new MRView(this,"DT",e,"Diffusion_tensor","Diffusion Tensor"),new MRView(this,"FA",e,"FA","FA"),new MRView(this,"MD",e,"MD","MD"),new MRView(this,
"B0",e,"Mean_B0","Mean B0"),new MRView(this,"DW",e,"Mean_DW","Mean DW"),new MRView(this,"RA",e,"RA","RA"),new MRView(this,"VR",e,"VR","VR"),new MRView(this,"CM",e,"CMAP","CMAP"),new AggregateMRView(this,"T1t",e,"t1-template","t1"),new AggregateMRView(this,"T2t",e,"t2-template","t2"),new AggregateMRView(this,"EFt",e,"exvivo-fa-template","exvivo-fa"),new AggregateMRView(this,"ESt",e,"exvivo-structural-template","exvivo-structural"),new AggregateMRView(this,"IFt",e,"invivo-fa-template","invivo-fa"),
new AggregateMRView(this,"IMt",e,"invivo-md-template","invivo-md"),new AggregateMRView(this,"PDt",e,"pd-template","pd"),new AggregateMRView(this,"BM",e,"brainmask","brainmask")]);e.setViewDefault("MR.T2");e.setViewDefault("aggregateMR.t1-template");this.addViewClass(e);e=new ViewerViewClass(this,"block","Block");e.setViews([new BlockView(this,"BL",e)]);e.setViewDefault("block");this.addViewClass(e);e=new ViewerViewClass(this,"hist","Histology");e.setViews([new HistView(this,"HI",e)]);e.setViewDefault("hist");
this.addViewClass(e);for(var g in this.view_classes)this.view_classes[g].loadResource();this.setCanvasElements();this.setLayers(this.layers.slice());this.setLayers(a.layers.split(","));this.setViews(new Set(a.view.split(",")));for(var h in this.view_classes)this.view_classes[h].updateVisibilityFromViews();this.drawScene();return a};
ViewerContext.prototype.setViews=function(a){a=new Set(a);var b=new Set,c=$jscomp.makeIterator(a);for(a=c.next();!a.done;a=c.next())a=a.value,this.valid_views.has(a)&&(b.add(a),this.views[a].activate());c=new Set;var d=$jscomp.makeIterator(this.valid_views);for(a=d.next();!a.done;a=d.next())a=a.value,b.has(a)||(c.add(a),this.views[a].deactivate());this.view_params.view=this.view=Array.from(b).join(",");this.setScopeVariable("view",this.view);for(var e in this.canvas)this.checkSliceBounds(e),this.checkPanBounds(e);
return this.view_params};ViewerContext.prototype._updateActiveViews=function(){var a=kvFilter(this.views,function(a,c){return c.active}).map(function(a){return a[0]});this.setViews(Array.from(a))};ViewerContext.prototype.toggleView=function(a){this.valid_views.has(a)&&this._updateActiveViews()};ViewerContext.prototype.toggleViewClass=function(a){a.updateVisibility();a.activateDefaultViews();this._updateActiveViews()};ViewerContext.prototype.toggleMinimap=function(){for(var a in this.canvas)this.canvas[a].toggleMinimap()};
ViewerContext.prototype.setLayers=function(a){if(a.length!=this.layers.length)return console.log("invalid layers length: "+a.length+":"+JSON.stringify(a)),this.view_params;for(var b in a){var c=a[b];if(!this.selectable_views.has(c))return console.log("invalid selectable id: "+c),this.view_params}this.layers.length=0;for(var d in a)b=a[d],this.views[b].layer=parseInt(d),this.layers.push(b);a=this.view_params.layers=this.layers.join(",");this.setScopeVariable("layers",a);for(var e in this.canvas)this.canvas[e].sortViews();
this.updatePageState();return this.view_params};ViewerContext.prototype.moveLayer=function(a,b){var c=this.layers.slice(),d=c.indexOf(a);if(0>d)return console.log("invalid layer "+a),this.view_params;a=c.splice(d,1)[0];b>d&&b--;c.splice(b,0,a);return this.setLayers(c)};ViewerContext.prototype.setNewSubject=function(a){if(a in this.subject_resources)this.onNewSubjectReady(a,this.subject_resources[a]);else this.getSubjectInfo(a,this.onNewSubjectReady.bind(this))};
ViewerContext.prototype.onNewSubjectReady=function(a,b){this.view_params.subject=this.subject_id=a;this.resource=b;this.subject_resources[this.subject_id]=this.resource;this.has_thickness=!1;this.modes.length=0;var c=this.modes;Object.keys(this.resource.modes).forEach(function(a){c.push(a)});this.setScopeVariable("subject",this.subject_id);for(var d in this.views)a=this.views[d],a.empty&&a.deactivate();this.session_names=[];for(var e in this.view_classes)d=this.view_classes[e],d.loadResource(),d.updateVisibilityFromViews(),
d.activateDefaultViews();for(var f in this.canvas)this.checkSliceBounds(f);this.updatePageState();return this.view_params};
ViewerContext.prototype.checkPanBounds=function(a,b){b=void 0!==b?b:this.axis_prefixes[this.axes.indexOf(a)];a="pan_"+b+"x";var c="pan_"+b+"y";this[a]=Math.min(this.max_pan,Math.max(this.min_pan,this[a]));this[c]=Math.min(this.max_pan,Math.max(this.min_pan,this[c]));this.view_params[b+"x"]=this[a]+"";this.view_params[b+"y"]=this[c]+"";a=(this[b+"zoom"]-this.min_zoom)/(this.max_zoom-this.min_zoom);c=this.max_level-this.min_level;var d=this[b+"level"]=this.max_level-Math.floor(c*a),e=(this.max_level-
d)/c;this[b+"scale"]=1+(this.mag_factor-1)*(a-e)/((this.max_level-(d-1))/c-e)||1;this[b+"magnification"]=Math.pow(this.mag_factor,this.max_level-d);for(var f in this.canvas)this.canvas[f].checkPanBounds();this.updatePageState()};ViewerContext.prototype.checkSliceBounds=function(a,b){b=void 0!==b?b:this.axis_prefixes[this.axes.indexOf(a)];var c=b+"slice";this["min_"+c]=this.resource.volume[a][0];this["max_"+c]=this.resource.volume[a][1];this.setSlice(a,this[c],b)};
ViewerContext.prototype.panCenter=function(a){var b=this.axis_prefixes[this.axes.indexOf(a)];this["pan_"+b+"x"]=this["pan_"+b+"y"]=0;this.checkPanBounds(a,b);this.updatePageState();return this.view_params};ViewerContext.prototype.setPan=function(a,b,c){var d=this.axis_prefixes[this.axes.indexOf(a)],e="pan_"+d+"x",f="pan_"+d+"y";b=parseFloatWithDefault(b);c=parseFloatWithDefault(c);this[e]=b;this[f]=c;this.checkPanBounds(a,d);this.updatePageState();return this.view_params};
ViewerContext.prototype.setCoronalPan=function(a,b){return this.setPan("coronal",a,b)};ViewerContext.prototype.setAxialPan=function(a,b){return this.setPan("axial",a,b)};ViewerContext.prototype.setSagittalPan=function(a,b){return this.setPan("sagittal",a,b)};
ViewerContext.prototype.addPan=function(a,b,c){var d=this.axis_prefixes[this.axes.indexOf(a)],e=this[d+"magnification"],f=this[d+"scale"],g="pan_"+d+"x",h="pan_"+d+"y";b=parseFloatWithDefault(b);c=parseFloatWithDefault(c);if(!b&&!c)return this.view_params;this[g]+=b/e/f;this[h]+=c/e/f;this.checkPanBounds(a,d);this.updatePageState();return this.view_params};ViewerContext.prototype.addCoronalPan=function(a,b){return this.addPan("coronal",a,b)};
ViewerContext.prototype.addAxialPan=function(a,b){return this.addPan("axial",a,b)};ViewerContext.prototype.addSagittalPan=function(a,b){return this.addPan("sagittal",a,b)};
ViewerContext.prototype.setZoom=function(a,b,c){c=void 0!==c?c:this.axis_prefixes[this.axes.indexOf(a)];b=Number.isInteger(b)?b:parseInt(b,10);if(isNaN(b))return this.view_params;var d=c+"zoom";this.view_params[d]=this[d]=Math.max(this.min_zoom,Math.min(this.max_zoom,b));this.checkPanBounds(a,c);this.setScopeVariable(d,this[d]);this.updatePageState();return this.view_params};ViewerContext.prototype.setCoronalZoom=function(a){return this.setZoom("coronal",a)};
ViewerContext.prototype.setAxialZoom=function(a){return this.setZoom("axial",a)};ViewerContext.prototype.setSagittalZoom=function(a){return this.setZoom("sagittal",a)};ViewerContext.prototype.incrementZoom=function(a){var b=this.axis_prefixes[this.axes.indexOf(a)];return this.setZoom(a,this[b+"zoom"]+1,b)};ViewerContext.prototype.decrementZoom=function(a){var b=this.axis_prefixes[this.axes.indexOf(a)];return this.setZoom(a,this[b+"zoom"]-1,b)};
ViewerContext.prototype.showInUI=function(a){switch(a){case "vol_crosshair":return!0;case "slice_thickness":return this.has_thickness}return!1};
ViewerContext.prototype.setSlice=function(a,b,c,d,e){var f=b;b=Number.isInteger(b)?b:parseInt(b,10);if(isNaN(b))return console.log("could not set "+a+" slice to "+f),this.view_params;c=void 0!==c?c:this.axis_prefixes[this.axes.indexOf(a)];var g=c+"slice";c=this["min_"+g];f=this["max_"+g];if(!e){if(null===c||null===f)return this.view_params;b=Math.max(c,Math.min(f,b))}this.view_params[g]=this[g]=b;this.setScopeVariable(g,this[g]);for(var h in this.views)e=this.views[h],e.selectable&&e.setSlice(a,b);
if(this.volume.width||this.volume.height||this.volume.depth)switch(b=d||(b-c)/(f-c)||0,a){case "coronal":this.crosshair.z=d?d:this.volume.back-b*this.volume.depth;this.view_params.pz=this.crosshair.z+"";break;case "axial":this.crosshair.y=d?d:this.volume.bottom+b*this.volume.height;this.view_params.py=this.crosshair.y+"";break;case "sagittal":this.crosshair.x=d?d:this.volume.left+b*this.volume.width,this.view_params.px=this.crosshair.x+""}this.updatePageState();return this.view_params};
ViewerContext.prototype.setCoronalSlice=function(a){return this.setSlice("coronal",a)};ViewerContext.prototype.setAxialSlice=function(a){return this.setSlice("axial",a)};ViewerContext.prototype.setSagittalSlice=function(a){return this.setSlice("sagittal",a)};ViewerContext.prototype.incrementSlice=function(a){var b=this.axis_prefixes[this.axes.indexOf(a)];return this.setSlice(a,this[b+"slice"]+1,b)};
ViewerContext.prototype.decrementSlice=function(a){var b=this.axis_prefixes[this.axes.indexOf(a)];return this.setSlice(a,this[b+"slice"]-1,b)};ViewerContext.prototype.getSlicePosition=function(a){var b=this.axis_prefixes[this.axes.indexOf(a)]+"slice";return(this[b]-Math.floor((this["min_"+b]+this["max_"+b])/2))*this.thickness[a]};ViewerContext.prototype.getCoronalSlicePosition=function(){return this.getSlicePosition("coronal")};ViewerContext.prototype.getAxialSlicePosition=function(){return this.getSlicePosition("axial")};
ViewerContext.prototype.getSagittalSlicePosition=function(){return this.getSlicePosition("sagittal")};
ViewerContext.prototype.setCrosshair=function(a,b,c){var d=a.axis,e=this.axis_prefixes[this.axes.indexOf(d)],f=1/this[e+"magnification"]/this[e+"scale"];b=Math.min(1,Math.max(0,Math.min(a.ortho_xoffset+a.ortho_xspan,Math.max(a.ortho_xoffset,b*f+this["pan_"+e+"x"]))-a.plane.left)/a.plane.width);a=Math.min(1,Math.max(0,Math.min(a.ortho_yoffset+a.ortho_yspan,Math.max(a.ortho_yoffset,c*f+this["pan_"+e+"y"]))-a.plane.bottom)/a.plane.height);switch(d){case "coronal":e=Math.trunc(Math.round(this.min_sa_slice+
b*(this.max_sa_slice-this.min_sa_slice)));c=Math.trunc(Math.round(this.min_ax_slice+a*(this.max_ax_slice-this.min_ax_slice)));b=this.volume.left+b*this.volume.width;a=this.volume.bottom+a*this.volume.height;this.setSlice("sagittal",e,void 0,b,"no_bounds");this.setSlice("axial",c,void 0,a,"no_bounds");break;case "axial":e=Math.trunc(Math.round(this.min_sa_slice+b*(this.max_sa_slice-this.min_sa_slice)));d=Math.trunc(Math.round(this.min_slice+a*(this.max_slice-this.min_slice)));b=this.volume.left+b*
this.volume.width;a=this.volume.back-a*this.volume.depth;this.setSlice("sagittal",e,void 0,b,"no_bounds");this.setSlice("coronal",d,void 0,a,"no_bounds");break;case "sagittal":d=Math.trunc(Math.round(this.min_slice+(1-b)*(this.max_slice-this.min_slice))),c=Math.trunc(Math.round(this.min_ax_slice+a*(this.max_ax_slice-this.min_ax_slice))),b=this.volume.back-(1-b)*this.volume.depth,a=this.volume.bottom+a*this.volume.height,this.setSlice("coronal",d,void 0,b,"no_bounds"),this.setSlice("axial",c,void 0,
a,"no_bounds")}return this.view_params};ViewerContext.prototype.crosshairCenter=function(){this.setCrosshair(this.canvas.coronal,0,0);this.setCrosshair(this.canvas.axial,0,0);this.setCrosshair(this.canvas.sagittal,0,0)};ViewerContext.prototype.getNumberOfActiveCanvas=function(){var a=0,b;for(b in this.canvas)this.canvas[b].isActive()&&a++;return a};
ViewerContext.prototype.addView=function(a){this.views[a.id]=a;a.name&&this.layers.push(a.id);this.valid_views.add(a.id);a.selectable&&this.selectable_views.add(a.id);return a};ViewerContext.prototype.addViewClass=function(a){this.view_classes[a.key]=a;for(var b in a.views)this.addView(a.views[b]);return a};
ViewerContext.prototype.updateVolume=function(){var a=this.canvas.coronal,b=this.canvas.sagittal,c=this.canvas.axial;this.volume.left=Math.max(null!=a.plane.left?a.plane.left:-Infinity,null!=c.plane.left?c.plane.left:-Infinity);this.volume.right=Math.min(null!=a.plane.right?a.plane.right:Infinity,null!=c.plane.right?c.plane.right:Infinity);this.volume.bottom=Math.max(null!=a.plane.bottom?a.plane.bottom:-Infinity,null!=b.plane.bottom?b.plane.bottom:-Infinity);this.volume.top=Math.min(null!=a.plane.top?
a.plane.top:Infinity,null!=b.plane.top?b.plane.top:Infinity);this.volume.back=Math.max(null!=c.plane.bottom?c.plane.bottom:-Infinity,null!=b.plane.right?b.plane.right:-Infinity);this.volume.front=Math.min(null!=c.plane.top?c.plane.top:Infinity,null!=b.plane.left?b.plane.left:Infinity);this.volume.width=this.volume.right-this.volume.left||0;this.volume.height=this.volume.top-this.volume.bottom||0;this.volume.depth=this.volume.back-this.volume.front||0};
ViewerContext.prototype.setSessionName=function(a){var b=$jscomp.makeIterator(a.split("-",2));a=b.next().value;b=b.next().value;this.view_params.session=b;this.view_params.vivo=a;"mri"in this.view_classes&&this.view_classes.mri.setVivoAndSession(a,b,null);"accessory-overlay"in this.view_classes&&this.view_classes["accessory-overlay"].setVivoAndSession(a,b,null)};ViewerContext.prototype.drawScene=function(){for(var a in this.canvas)this.canvas[a].drawScene()};(function(){var a=angular.module("app.atlas",["angularSpinner","dndLists"]);a.controller("ViewerController",["$scope","$state","$http","$compile","$timeout","usSpinnerService","SMDAAccount",function(a,c,d,e,f,g,h){a.tooltip_delay=1E3;a.dropViewLayer=function(b,c){a.context.moveLayer(c,b);return!0};a.setCanvasParent=function(b){a.pan={};a.context=new ViewerContext($(b),{getSavedValue:function(a){h.getValue(a)},setSavedValue:function(a,b){h.setValue(a,b)},hasSavedValue:function(a){return h.hasValue(a)},
getScopeVariable:function(b){return a[b]},setScopeVariable:function(b,c){a[b]=c},createSpinnerElement:function(b,c){c=c||{color:"#fff"};b="<span us-spinner="+JSON.stringify(c)+' spinner-key="'+b+'" spinner-start-active="true"></span>';return e(b)(a)},activateSpinner:function(a){g.spin(a)},deactivateSpinner:function(a){g.stop(a)},getSubjects:function(){(function(b,c){d({method:"GET",url:b}).then(function(b){a.context.subjects.push.apply(a.context.subjects,b.data)},function(a){console.log("Failed to retrieve subjects: "+
JSON.stringify(a))})})("/smda/info/subjects",c.params)},getSubjectInfo:function(a,b){(function(b,e){d({method:"GET",url:b}).then(function(b){c.go(c.current,e(a,b.data),{notify:!1})},function(a){console.log("Failed to retrieve subject data: "+JSON.stringify(a))})})("/smda/info/"+a,b)},updatePageState:function(){f(function(){c.go(c.current,a.context.view_params,{notify:!1})})},requestHTTP:function(a,b,c){d(a).then(b,c)}});(function(b,e){d({method:"GET",url:b}).then(function(b){c.go(c.current,a.context.setResource(b.data,
e),{notify:!1})},function(a){console.log("Failed to retrieve subject data: "+JSON.stringify(a))})})("/smda/info/"+c.params.subject,c.params)};a.$on("$stateChangeStart",function(a,b,c,d,e,f){});a.$on("$stateChangeSuccess",function(a,b,c,d,e,f){});a.$on("$stateChangeError",function(a,b,c,d,e,f){});return a}]);a.config(["usSpinnerConfigProvider",function(a){a.setDefaults({opacity:0})}]);a.directive("viewerContainer",function(){return{restrict:"E",controller:"ViewerController",controllerAs:"viewer",templateUrl:"html/viewer.html"}});
a.directive("viewerPanelContainer",["$parse",function(a){return{restrict:"A",scope:!1,link:function(a,b){"context"in a||a.setCanvasParent(b)}}}]);a.directive("rangeValidation",["$parse",function(a){return{restrict:"A",require:"ngModel",scope:!1,link:function(b,d,e,f){b.$watch(e.ngModel,function(c,d){if(c!=d)if(isNaN(c))f.$setViewValue(d),f.$render();else{c=Math.min(e.max,Math.max(e.min,parseInt(c,10)));if(e.rangeMaxLink){var g=b.$eval(e.rangeMaxLink);a(e.rangeMaxLink).assign(b,Math.max(c,g))}e.rangeMinLink&&
(g=b.$eval(e.rangeMinLink),a(e.rangeMinLink).assign(b,Math.min(c,g)));c!==d&&a(e.ngModel).assign(b,c)}});f.$parsers.push(function(a){return""+a});f.$formatters.push(function(a){return parseInt(a,10)});d.on("keypress",function(a){/^[\-?\d]$/.test(String.fromCharCode(a.which))||a.preventDefault()})}}}]);a.directive("numberConvert",function(){return{restrict:"A",require:"ngModel",scope:!1,link:function(a,c,d,e){e.$parsers.push(function(a){return""+a});e.$formatters.push(function(a){return parseInt(a,
10)})}}});a.controller("PanelController",["$scope",function(a){a.tab=1;a.selectTab=function(b){a.tab=b};a.isSelected=function(b){return a.tab===b};return a}]);a.config(["$stateProvider",function(a){a.state("main.atlas",{url:"/atlas",abstract:!0,templateUrl:"/smda/html/atlas.html"});a.state("main.atlas.viewer",{url:"/viewer?{subject}&{view}&{layers}&{slice:int}&{ax_slice:int}&{sa_slice:int}&{zoom:int}&{ax_zoom:int}&{sa_zoom:int}&{px}&{py}&{pz}&{x}&{y}&{ax_x}&{ax_y}&{sa_x}&{sa_y}&{stain}&{proc}&{session:int}&{param}&{vivo}&{Diffusion_tensor_vol}&{RA_vol}&{VR_vol}&{label}&{glyph}&{block_a:int}&{hist_a:int}&{MR_a:int}&{label_a:int}&{glyph_a:int}",
params:{subject:"default",view:"BL",layers:"BL,HI",slice:128,ax_slice:1,sa_slice:1,zoom:1,ax_zoom:1,sa_zoom:1,px:"0",py:"0",pz:"0",x:"0",y:"0",ax_x:"0",ax_y:"0",sa_x:"0",sa_y:"0",stain:"BDA",proc:"T2",session:1,param:"",vivo:"exvivo",Diffusion_tensor_vol:"1",RA_vol:"1",VR_vol:"1",label:"roi",glyph:"DTI",block_a:100,hist_a:100,MR_a:100,label_a:100,glyph_a:100}})}]);a.run(["$rootScope","$state",function(a,c){a.$on("$stateChangeStart",function(a,b,c,g,h){})}])})();
